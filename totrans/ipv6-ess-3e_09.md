## 第八章 移动 IPv6

过去，我们习惯于在家中或办公室打电话。公共电话亭使我们能够在外出时打电话。今天，使用手机已经变得非常普遍，我们几乎可以在任何地方、任何生活场景下拨打电话。笔记本电脑、无线网络和便携设备的使用不断增加，我们可以想象，无论身处何地，都能使用智能设备。如果这些设备要使用 IP 作为传输协议，我们需要移动 IP 来使其工作。我们希望设备在移动时保持连接，并能在更换接入网络的地点时不中断连接，就像今天我们习惯于在手机上从一个基站漫游到另一个基站一样。例如，假设你有一台配备 802.11（无线）接口和 UMTS（通用移动通信系统）接口的平板电脑。在酒店房间里，你通过无线接口连接到网络；当你离开房间走到街上时，你会自动切换到 UMTS，而不会丢失连接。所有的应用程序，例如正在运行的 Skype 会话或语音通话，都不会中断。是不是很酷？这一节关于移动 IP 的内容探讨了实现这一目标所需的机制，并展示了 IPv6 如何为这一挑战做好准备。

无论是 IPv4 还是 IPv6，前缀（子网地址）都会根据我们所连接的网络发生变化。当移动节点改变其接入网络的方式时，它需要获取一个新的 IP 地址，这会中断其 TCP 或 UDP 连接。RFC 5944《IPv4 的 IP 移动性支持》描述了 IPv4 的移动 IP 概念和规范。然而，使用 IPv4 的移动 IP 存在一些局限性，使其不适用于全球网络中的需求。一个原因是地址空间的有限性。如果我们仅仅想象智能手机需要一个 IP 地址，那么全球所需的地址数量将远远超过可用的 IPv4 地址空间。另一个原因是 IPv6 及其扩展头的使用为移动世界中的路由优化提供了可能，这在讨论大量设备的移动性时尤为重要。IPv6 使用邻居发现（而非像 IPv4 那样使用 ARP）使其更加独立于链路层。移动 IPv6 借鉴了移动 IPv4 的经验，并利用了 IPv6 的先进特性。

本章描述了移动 IPv6 如何工作以及它如何为未来的移动服务提供基础。首先，我将解释本章中将使用的最重要术语，然后提供功能概述，之后深入探讨协议的技术细节：新的头部、消息、选项、过程和通信。所以，深呼吸一下，继续阅读。

## 概述

移动 IPv6 是一种协议，允许移动节点在不同网络之间切换而不丢失连接。它在 RFC 6275 中有所规定。

大多数互联网流量使用 TCP 连接。TCP 连接由通信双方端点的 IP 地址和端口号的组合来定义。如果这四个数字中的任何一个发生变化，通信就会中断并需要重新建立。如果一个移动节点连接到不同的网络，它需要一个新的 IP 地址。移动 IP 解决了在不更改 IP 地址的情况下将节点移动到不同连接点的挑战，通过为移动节点的接口分配一个新的附加 IP 地址。此时，移动节点仍然知道它的*主地址*，这个地址是静态的并且不会改变，因此用于标识 TCP 连接。新的 IP 地址被称为*Care-of 地址*。它根据节点当前附着的网络而变化。因此，这在同质网络中有效（如果节点从一个以太网段移动到另一个以太网段），也适用于异质网络（如果节点从一个以太网段移动到无线局域网或 UMTS）。

在无线网络中，我们熟悉*切换*，即设备从一个接入点移动到另一个接入点的事件。这是在链路层的切换。移动 IPv6 解决了网络层的切换问题，并在设备更改其临时 IP 地址时保持与应用程序和服务的连接。

### 移动 IPv6 术语

以下是本章中使用的一些术语的定义。

*主地址*

分配给移动节点的全局单播地址。它作为该节点的永久地址，并位于移动节点的主链路内。常规路由机制将数据包传送到移动节点的主地址。

*主子网前缀*

对应移动节点主地址的 IP 子网前缀。

*主链路*

定义移动节点主子网前缀的链路。

*移动节点*

一种可以在不同链路间切换附着点的节点，同时仍可以通过其主地址进行访问。

*通信节点*

与移动节点进行通信的对等节点。通信节点可以是移动的也可以是静态的。

*外部子网前缀*

除移动节点主子网前缀外的任何 IP 子网前缀。

*外部链路*

除移动节点主链路以外的任何链路。

*Care-of 地址*

移动节点在外部网络（远离主网络）中的全局单播地址。Care-of 地址的子网前缀为外部子网前缀。一个移动节点可能有多个 Care-of 地址。注册到其主代理的 Care-of 地址是主要 Care-of 地址。

*主代理*

移动节点家庭链路上的一台路由器，移动节点已将其当前的 Care-of 地址注册到该路由器。当移动节点不在家时，家庭代理会拦截发往该移动节点家庭地址的数据包，封装它们（IPv6 封装），并通过隧道传送到移动节点的注册 Care-of 地址。

*绑定*

移动节点的家庭地址与该移动节点的 Care-of 地址之间的关联，以及该关联的剩余生命周期。

*注册*

移动节点将绑定更新发送给其家庭代理或通信节点，从而使得该移动节点的绑定被注册。与通信节点的注册称为通信节点注册（Correspondent Registration）。

*绑定授权*

需要通过通信节点进行注册授权，以便接收方确保发送方有权指定新的绑定。

*返回可达性过程*

通过加密令牌交换授权注册的过程。

*密钥生成令牌*

由通信节点在返回可达性过程（Return Routability Procedure）中提供的一个编号，用于使移动节点计算必要的绑定管理密钥，以授权绑定更新（Binding Update）。

*随机数*

在创建与返回可达性过程相关的密钥生成令牌时，通信节点内部使用的随机数。这些随机数并不特定于某个移动节点，并且保密存储在通信节点内。

*随机数索引*

用于指示在创建密钥生成令牌（keygen token）值时已使用哪些随机数，而不暴露这些随机数本身。

### 移动 IPv6 的工作原理

图 8-1 展示了移动 IPv6 的组成部分及其如何相互作用。

![移动 IPv6 概述](img/ipv6_0801.png)图 8-1. 移动 IPv6 概述

家庭地址是一个位于*移动节点*（*MN*）的家庭链路前缀内的 IPv6 地址。只要移动节点处于家庭网络中，它通过常规的 IP 路由机制接收数据包，表现得就像任何其他普通 IP 主机一样。当移动节点处于外部网络（外链路）时，它会有一个额外的暂时地址（Care-of 地址）。它通过常规 IPv6 机制，如 SLAAC（无状态地址自动配置）或 DHCPv6，在连接到新的链路时获取 Care-of 地址。

家庭地址与 Care-of 地址之间的关联称为*绑定*。当移动节点离家时，它会将自己的 Care-of 地址注册到家庭链路上的一台路由器，即其*家庭代理*（*HA*）。为了注册 Care-of 地址，移动节点向家庭代理发送绑定更新消息。家庭代理回应一个绑定确认。与移动节点通信的每个节点称为*通信节点*（*CN*）。移动节点也可以直接向通信节点发送注册消息（称为通信节点注册）。通信节点也可以是一个移动节点。

有两种通信方式供通信节点和移动节点使用：

*双向隧道*

来自通信节点的数据包被发送到主机代理，主机代理将它们封装成 IPv6 格式并发送到移动节点的 Care-of 地址。来自移动节点的数据包通过反向隧道发送到主机代理，主机代理通过常规路由机制将其转发到通信节点。这种模式不要求通信节点支持任何移动 IPv6，并且在不需要通信节点注册的情况下也能工作。

*路由优化*

使用路由优化后，移动节点与通信节点之间可以直接通信，而无需经过主机代理。这是移动 IPv6 相对于移动 IPv4 的主要优势之一，因为在移动 IPv4 中，路由优化是不可能的。路由优化要求移动节点将其 Care-of 地址注册到通信节点（称为通信节点注册），并且该绑定通过返回可达性过程（在本章后面“返回可达性过程”一节中讨论）获得授权。通信节点在直接向移动节点发送数据包时使用特殊的路由头（类型 2）。移动节点在向通信节点发送数据包时使用主机地址选项（为移动 IPv6 定义）。整个过程将在本章稍后部分进行更详细的描述。

路由优化的优点是，通信节点与移动节点之间可以使用最短的路径。数据包无需经过主机代理。这不仅确保了更短的通信路径，还减少了主机代理和主机链接的负载。当我们讨论大量移动节点不断移动时，特别是在 VoIP（语音 IP）场景中，或使用智能手机时，这一点尤为重要。

移动 IPv6 还支持多个主机代理的选项，移动节点可以通过动态主机代理地址发现（Dynamic Home Agent Address Discovery）得知其主机链接的重新配置或主机代理 IP 地址的变化。如果其主机链接的前缀发生变化，移动节点则使用移动前缀发现机制来获取新前缀。

以下各节将更详细地描述协议和新的消息、选项以及标志。之后，我将深入介绍刚才概述的通信流程。有些人喜欢这样学习；而另一些人则喜欢先了解过程和流程，然后再学习技术细节。请按照最适合您偏好的顺序阅读各节内容。

## 移动 IPv6 协议

本节描述了移动 IPv6 的组件、消息和选项。

### 移动头和移动消息

移动性头部（MH）已为移动 IPv6 定义。它是一个扩展头部，供移动节点、对应节点和家庭代理使用。它用于所有与建立和维护绑定相关的消息。

移动性头部由前一个头部中的下一个头部值 135 指定，其格式如图 8-2 所示。

![移动性头部格式](img/ipv6_0802.png)图 8-2. 移动性头部格式

负载协议字段对应于下一个头部字段，并标识下一个头部。因此，它可以包含与下一个头部字段相同的值。当前规范将此字段的值设置为 59（十进制），表示“无下一个头部”。它旨在用于未来的扩展。头部长度字段包含移动性头部的长度，单位为 8 字节。前 8 字节不计算在内。移动性头部的长度始终是 8 字节的倍数。校验和字段包含移动性头部的校验和。它是基于伪头部计算的，并遵循 RFC 2460 中定义的规则。伪头部中使用的地址是 IPv6 头部中的源地址和目标地址。如果移动性消息包含家庭地址目标选项，则使用家庭地址来计算校验和。MH 类型字段标识移动性消息的类型。已定义的消息列在表 8-1 中。数据字段是可变的，取决于消息类型。

表 8-1 是移动性消息的概述。

表 8-1. 移动性消息类型

| 值 | 消息类型 | 描述 | RFC |
| --- | --- | --- | --- |
| 0 | 绑定刷新请求 | 由 CN 发送，请求 MN 更新其绑定。 | RFC 6275 |
| 1 | 家庭测试初始化 | 由 MN 发送以启动返回可达性过程并向 CN 请求家庭密钥生成令牌。通过隧道经过 HA 发送给 CN。 | RFC 6275 |
| 2 | 外部地址测试初始化 | 由 MN 发送以启动返回可达性过程并向 CN 请求密钥生成令牌。直接发送给 CN。 | RFC 6275 |
| 3 | 家庭测试消息 | 响应家庭测试初始化消息（类型 1）。由 CN 发送给 MN。包含一个 cookie 和一个家庭密钥生成令牌，用于返回可达性过程中的授权。通过 HA 隧道发送。 | RFC 6275 |
| 4 | 外部地址测试消息 | 响应外部地址测试初始化消息（类型 2）。由 CN 发送给 MN。包含 cookie 和一个外部地址密钥生成令牌，用于返回可达性过程中的授权。直接发送给 MN。 | RFC 6275 |
| 5 | 绑定更新 | 由 MN 发送以通知其外部地址的变化。此消息将在本章稍后详细解释。 | RFC 6275 |
| 6 | 绑定确认 | 作为确认接收到绑定更新消息的响应发送。该消息将在本章后面详细解释。 | RFC 6275 |
| 7 | 绑定错误 | 由 CN 发送，用于指示与移动性相关的错误，例如在没有现有绑定的情况下，尝试使用 Home Address Destination 选项。状态字段可以具有以下值：1 = Home Address Destination 选项的未知绑定；2 = 未识别的 MH 类型值 | RFC 6275 |
| 8 | 快速绑定更新 | 与绑定更新消息相同，仅具有稍微不同的处理规则。 | RFC 5568 |
| 9 | 快速绑定确认 | 作为确认接收到快速绑定更新消息的响应发送。 | RFC 5568 |
| 10 | 快速邻居广告 | 已弃用。 | RFC 5568 |
| 11 | 实验性移动头 | 为测试新消息类型而定义，不会与标准化的值发生冲突。 | RFC 5096 |
| 12 | 主机代理切换 | 从 HA 发送到 MN，强制 MN 配置新的 HA。 | RFC 5142 |
| 13 | 心跳 | 由 MAC 和 LMA 发送，以验证可达性的状态（代理移动 IPv6）。 | RFC 5847 |
| 14 | 切换初始化 | 在接入路由器之间发送，用于初始化移动节点的切换过程。 | RFC 5568 |
| 15 | 切换确认 | 由接入路由器发送，用于确认接收到切换初始化消息。 | RFC 5568 |
| 16 | 绑定撤销 | 由移动节点发送以终止绑定：1 = 绑定撤销指示；2 = 绑定撤销确认 | RFC 5846 |
| 17 | 本地路由初始化 | 由 LMA 或 MAG 发送，用于初始化本地路由（代理移动 IPv6）。 | RFC 6705 |
| 18 | 本地路由确认 | 由 LMA 或 MAG 作为对本地路由初始化的响应发送。 | RFC 6705 |

为帮助你理解绑定，下一节将更详细地探讨绑定更新和绑定确认消息。

### 注

你可以在[`www.iana.org/assignments/mobility-parameters`](http://www.iana.org/assignments/mobility-parameters)找到所有消息和选项类型以及状态代码。

### 绑定更新消息

绑定更新消息用于移动节点通知主机代理或对应节点一个新的 Care-of 地址。该消息还用于扩展现有绑定的生命周期。

绑定更新消息是 MH 类型 5，格式如图 8-3 所示。

![绑定更新消息的格式](img/ipv6_0803.png)图 8-3. 绑定更新消息的格式

序列号由接收节点用于对 Binding Updates 进行排序。发送节点使用它来验证接收到的 Binding Acknowledgments 是否与其 Binding Updates 对应。如果移动节点期望对其 Binding Update 的响应，Acknowledge 位（A-Bit）会被设置。Home Registration 位（H-Bit）由移动节点设置，表示请求接收方充当该节点的家庭代理。只有当接收方位于移动节点的家庭链路上时，这才是可能的。Link-Local 地址兼容性位（L-Bit）如果家庭地址具有与移动节点的链路-local 地址相同的接口标识符，则设置该位。密钥管理移动能力位（K-Bit）仅在发送到家庭代理的 Binding Updates 中有效。如果 IPsec 安全关联应在移动节点移动到另一个网络后继续有效，则 K-Bit 被设置。如果不可能，则 K-Bit 被设置为 0。通信节点忽略 K-Bit。生命周期字段表示 Care-of 地址的绑定有效期（以四秒为单位）。如果生命周期设置为 0，则接收方必须删除其 Binding 缓存中的条目。在这种情况下，移动节点必须处于其家庭链路上，并且 Care-of 地址与家庭地址相同。

在图 8-3 中显示的 M-Bit 被额外创建用来识别发送到本地家庭代理的本地 Binding Update，该代理称为*移动锚点*（MAP）。这个新节点用于改善移动 IPv6 切换性能，以便在同一地理区域内获得移动节点与通信节点之间的高效路由，并实现位置隐私。该机制在 RFC 4140《分层移动 IPv6》中定义，并在本章末尾有更详细的解释。当 M-Bit 被设置时，H-Bit 不能被设置，反之亦然。

Binding Update 可以包含以下选项：

+   Binding 授权数据选项（此选项在发送到通信节点的 Binding Updates 中是必需的）

+   Nonce 索引选项

+   替代的 Care-of 地址选项

### Binding Acknowledgment

Binding Acknowledgment 用于确认接收到 Binding Update。如果 Binding Update 中的 A-Bit 被设置，则必须发送 Binding Acknowledgment。如果 A-Bit 没有被设置（这意味着 Binding Update 的发送方不要求确认），则只有在 Binding Update 出现问题时才会发送 Binding Acknowledgment。如果接收方接受 Binding Update 并且 A-Bit 没有设置，则不发送确认。

Binding Acknowledgment 属于 MH 类型 6，其格式如图 8-4 所示。

![Binding Acknowledgment 格式](img/ipv6_0804.png)图 8-4. Binding Acknowledgment 格式

状态字段表示绑定更新的状态。表 8-2 显示了状态值。值范围为 0 到 127 表示绑定更新已被接受。值大于 128 表示绑定更新未被接受。

表 8-2. 绑定确认中的状态值

| 值 | 描述 |
| --- | --- |
| 0 | 绑定更新已接受 |
| 1 | 已接受，但需要前缀发现 |
| 128 | 原因未指定 |
| 129 | 行政禁止 |
| 130 | 资源不足 |
| 131 | 不支持家庭注册 |
| 132 | 非家庭子网 |
| 133 | 不是该移动节点的家庭代理 |
| 134 | 地址重复检测失败 |
| 135 | 序列号超出窗口 |
| 136 | 已过期的家庭随机数索引 |
| 137 | 已过期的 Care-of 随机数索引 |
| 138 | 已过期的随机数 |
| 139 | 禁止注册类型更改 |

这些是 RFC 6275 中定义的状态值。还有更多来自其他规范的状态值，如 NEMO 或代理移动 IPv6（在 NEMO 和代理移动 IPv6 部分中讨论）。

### 注意

查找完整的状态码列表，访问 [`www.iana.org/assignments/mobility-parameters`](http://www.iana.org/assignments/mobility-parameters)。

K 位是密钥管理移动性能力位（请参阅之前在绑定更新消息部分中的描述）。该位仅在移动节点和家庭代理之间的绑定中重要。通信节点会忽略此位。绑定确认中的序列号是从绑定更新中的序列号字段复制的。它用于移动节点将此绑定确认与未完成的绑定更新进行匹配。生命周期以 4 秒为单位，表示 Care-of 地址绑定的有效时间。在此期间，家庭代理或通信节点会将该绑定条目保存在其绑定缓存中。在表示绑定未被接受的绑定确认中（值为 128 或更高），不会指定生命周期。

一个绑定确认可以包含以下选项：

+   绑定授权数据选项（此选项在由通信节点发送的绑定确认中是强制性的）

+   绑定刷新建议选项

### 绑定撤销

在某些情况下，可能需要通知 MN 其无法再接收主机地址的移动 IPv6 服务。为此，RFC 5846 定义了绑定撤销机制。它使用一个新的移动性头（类型 16；参见 表 8-1）。该撤销机制可用于移动 IPv6 以及代理移动 IPv6（RFC 5213；在 代理移动 IPv6 部分中描述）。

在本规范中定义了以下新术语：

*发起方*

启动绑定撤销过程的移动性节点。它向其对等节点（例如，主机代理、本地移动锚点或移动接入网关）发送绑定撤销消息。

*响应方*

接收绑定撤销消息并响应绑定撤销确认的移动性节点（例如，移动节点、移动接入网关或本地移动锚点）。

为了撤销绑定，HA 向 MN 发送 *绑定撤销指示*（BRI）消息。为了指示绑定，HA 将主机地址包含在消息中（在类型 2 路由头中）。在双栈移动 IP（DSMIPv6）的情况下，也可以包括 IPv4 主机地址选项。如果 MN 注册了多个 Care-of 地址，HA 会在撤销消息中包含绑定标识符（BID）选项，以标识哪个绑定被撤销。当 MN 收到包含其主机地址的类型 2 路由头的绑定撤销指示消息时，它会响应绑定撤销确认消息。

类似地，在代理移动 IPv6 的情况下，本地移动锚点向移动接入网关发送撤销消息。在这种情况下，本地移动锚点包括移动节点主机网络前缀选项和移动节点标识符选项。

### 移动性选项

移动性消息可以包含零个、一个或多个选项。这些选项被包含在移动性头的可变数据字段中。该架构非常灵活，因为选项只有在需要时才插入，并且未来可以轻松定义额外的选项。

选项的存在通过移动性头中的头部长度字段指示。它们采用已知的 TLV 格式（类型 1 字节，长度 1 字节，值可变）。

表 8-3 包含当前定义的移动性消息选项概览。

表 8-3. 移动性选项

| 值长度 | 名称 | 描述 |
| --- | --- | --- |
| 类型 0 | Pad1 | 用于插入一个填充字节。此选项具有特殊格式；它仅包含类型字段，没有长度和数据字段。 |
| 类型 1 | PadN | 用于插入两个或更多填充字节。 |
| 类型 2 长度 2 | 绑定刷新建议 | 指示 MN 应该发送新的主机注册到 HA 的剩余时间。仅在 HA 对主机注册响应时发送的绑定确认中有效。该间隔必须小于绑定确认中的 Lifetime 值。时间单位为四秒。 |
| 类型 3 长度 16 | 备用 Care-of 地址 | 包含用于作为绑定的 Care-of 地址的地址，而不是使用数据包的源地址作为 Care-of 地址。仅在绑定更新消息中有效。 |
| 类型 4 长度 4 | 随机数索引 | 除了类型和长度字段外，还包含两个附加字段。Home Nonce Index 字段告诉 CN 在生成 Home Keygen Token 时使用哪个随机数值。Care-of Nonce 字段指示用于生成 Care-of Keygen Token 的值。仅在发送到 CN 的绑定更新消息中有效，并且只有与绑定授权数据选项一起出现时有效。 |
| 类型 5 长度 可变 | 绑定授权数据 | 包含一个加密值，用于确定该消息来自正确的授权机构。计算此值的规则取决于所使用的授权程序。必须始终是 MH 中的最后一个选项。仅在绑定更新和绑定确认中有效。用于返回可达性过程。在这种情况下，Authenticator 值的计算基于 MN 的 Care-of 地址、CN 的 IPv6 地址和来自 MH 的数据。 |
| 类型 201 长度 16 | 主机地址 | 包含 MN 的主机地址。当 MN 离家时，发送给接收方以指示其主机地址。通过目标选项头传输。必须插入在路由头之后，分片头、AH 或 ESP 头（如果存在）之前。 |

除了绑定授权数据选项外，这些选项可以以任意顺序出现。主机地址选项是一个例外，因为它通过目标选项头传输，而不是通过移动性头（MH）。

### 注意

再次强调，可以在 [`bit.ly/1nabH2o`](http://bit.ly/1nabH2o) 查阅包括其他规范中选项的完整移动选项列表。

RFC 4283，“Mobile IPv6（MIPv6）的移动节点标识符选项”扩展了原始规范，允许 MIPv6 节点（HA、CN、MN）使用除 IP 地址以外的标识符。它定义了一个具有子类型编号的选项，用于指定标识符类型。标识符类型可以是网络接入标识符（NAI；见 RFC 4282）、国际移动台标识符（IMSI）或特定应用/部署的不可见标识符。将来将指定更多标识符类型。

### 路由头类型 2

移动 IPv6 定义了一个新的路由头。这个扩展头允许在不通过家庭代理路由的情况下，移动节点的临时地址与对应节点之间的数据交换。换句话说，当在成功执行返回可路由性过程后使用路由优化进行通信时，就会使用此扩展头。

RFC 6275 定义了类型 2 路由头。它允许对防火墙中的移动 IPv6 数据包配置特定规则，除此之外还有其他功能。

当一个对应节点使用路由优化向移动节点发送 IPv6 数据报时，IPv6 头部中的目标地址字段包含了移动节点的临时地址。插入的路由头类型 2 包含了移动节点的家庭地址。路由头类型 2 只能包含一个单播地址。处理这些路由头的 IPv6 节点必须验证其中包含的 IPv6 地址是否与移动节点的家庭地址相对应。

路由头类型 2 的格式见第三章（图 3-6 和 3-7）。头部扩展长度字段的值为 2；此头部没有可变长度，因为它仅包含一个地址。在路由类型字段中，值为 2，并且“剩余段数”字段设置为 1，表示只有一个地址。家庭地址字段携带了移动节点的家庭地址。该路由头类型 2 的使用和处理方式将在本章后续部分描述。

## ICMPv6 与移动 IPv6

本节描述了两种新的 ICMPv6 消息对以及为支持移动 IPv6 所做的一些邻居发现（ND）修改。

### 家庭代理地址发现

移动节点使用家庭代理地址发现机制来确定其家庭链路上家庭代理的地址。为此，移动节点使用两种新的 ICMPv6 消息对和家庭代理列表，后者是由每个家庭代理维护的列表。

#### ICMPv6 家庭代理地址发现消息

这一消息对包括家庭代理地址发现请求和回复消息。顾名思义，移动节点使用这些消息动态查找其家庭链路上的家庭代理。通常，移动节点会静态配置一个家庭代理地址。如果家庭代理地址发生重新编号或代理发生故障并被具有不同 IP 地址的新家庭代理替代，则动态发现家庭代理地址可能是一种有用的机制。

移动节点将发现消息发送到其家庭链路上的家庭代理任播地址（任播 ID 十进制 126，十六进制`0x7E`；见第二章）。IPv6 头部中的源地址字段携带了移动节点的临时地址。

配置为家庭代理任播地址的家庭链路上的家庭代理通过家庭代理地址发现回复消息进行响应。

发现消息的类型值为 144；回复消息的类型值为 145。代码字段始终设置为 0。标识符字段由移动节点插入，并由家庭代理在回复中复制。这可以用来识别对应的消息。回复携带一个家庭地址字段，该字段可以包含一个或多个家庭代理地址。这个地址或地址列表是根据家庭代理列表生成的（如下一节所述）。

### 注意

有关 ICMPv6 消息头字段的详细描述，请参考第四章。

#### 家庭代理列表

每个家庭代理需要维护一个家庭代理列表。在该列表中，必须列出与同一链路连接并提供家庭代理服务的每个路由器。路由器通过在路由器通告中设置 H 位，向外宣告自己作为一个家庭代理。每个路由器为其作为家庭代理的每个链路维护一个家庭代理列表。该列表通过路由器通告进行更新，包含以下信息：

+   链路上家庭代理的链路本地地址。该地址从 IPv6 头部中设置了 H 位（家庭代理位）的路由器通告的源地址字段中学习得到。

+   一个或多个这些家庭代理的全球 IPv6 单播地址。这些地址是从路由器通告中的前缀选项（Prefix option）学习得到的。

+   此家庭代理（HA）条目的剩余生存时间。当生存时间到期时，必须将该家庭代理从列表中删除。

+   该家庭代理的优先级。较高的值表示较高的优先级。此值从路由器通告中的家庭代理信息选项（Home Agent Information）中的家庭代理优先级字段学习得来（如果存在）。如果不存在，则此值设置为 0。家庭代理使用此优先级在发送家庭代理地址发现回复消息时对家庭代理列表进行排序。

发送家庭代理地址发现回复（Home Agent Address Discovery Reply）时，必须列出链路上的所有家庭代理，并按优先级排序。回复消息中的家庭代理地址字段仅包含家庭代理的全球 IPv6 单播地址。回复的大小不得超过 1,280 字节。按优先级排序确保具有较高优先级的家庭代理会在此数据包中列出。

### 移动前缀请求

移动前缀请求（Mobile Prefix Solicitation）消息由离开家庭的移动节点发送，用于确定其家庭链路的前缀配置变化（即家庭网络重新编号）。家庭代理通过前缀通告（Prefix Advertisement）回答请求消息。根据此回复，移动节点可以调整其家庭地址。

移动节点向其 HA 发送 ICMPv6 移动前缀请求消息。IPv6 头部将原地址作为源地址，插入家庭地址目标选项。支持 IPsec 头，并应使用。移动前缀请求可以携带必须遵循第四章（RFC 4861）中描述的格式的选项。目前，没有定义具体的选项。移动前缀请求消息的类型值字段设置为 146；代码字段设置为 0。

HA 向移动节点的原地址发送 ICMPv6 移动前缀广告消息。HA 还可以定期发送非请求式广告。广告携带类型为 2 的路由头。回复消息发送到请求消息的源地址。如果是非请求式广告，则发送到已注册移动节点的原地址。广告的类型值设置为 147。如果是对请求的回应，标识符将从请求消息中复制。广告包含在第四章中描述的前缀选项。它携带所有应该由移动节点用来配置其家庭地址的前缀。

### 邻居发现（ND）中的变化

在 ND 中定义了一些变化和新选项，以便与移动 IPv6 一起使用。

#### 修改后的路由器广告格式

如在第四章中已提到，路由器广告中新增了一个标志。M 标志和 O 标志后面跟着 H 标志，该标志允许路由器在此链路上广告其作为主机代理的角色。

#### 修改后的前缀选项

为了基于路由器广告构建更新后的 HA 列表，移动节点必须知道路由器的全局单播地址。常规的路由器广告只列出了路由器的链路本地地址。为此，前缀选项已经进行了修改。前缀选项现在携带一个额外的标志——R 标志（路由器地址）。当设置该标志时，表示前缀选项字段不包含前缀，而是包含路由器的全局 IPv6 单播地址。

#### 新的广告间隔选项

广告间隔选项用于路由器广告中。它表示路由器发送非请求式多播路由器广告的间隔时间。该选项采用 TLV 格式（时间、长度、值），类型值为 7。广告间隔字段占 4 字节，表示路由器广告之间的毫秒时间间隔。移动节点在其移动检测算法中使用此信息（该算法将在本章后续部分介绍）。

邻居发现规范为无请求的多播路由器广告设置了最小间隔为三秒。移动节点依赖于尽可能快速地学习，当移动到新网络时，相应地创建新的临时地址并发送绑定更新。它们通过来自尚未认识的路由器的路由器广告来检测自己是否移动到新网络。因此，支持移动 IPv6 的路由器必须能够配置为更短的路由器广告间隔。或者，可以使用来自更低层（即第二层）的移动信息来帮助移动节点更快地检测移动。

#### 新的主机代理信息选项

主机代理信息选项用于路由器广告，并遵循 TLV 格式。类型值为 8。

HA 优先级字段的长度为 2 字节。在路由器广告中，HA 可以使用此字段指示应与其关联的优先级级别。较高的值表示较高的优先级。当此选项未设置时，HA 的优先级为 0。该字段可由 HA 用于动态调整以应对不同情况，例如当前连接的移动节点数量或可用资源多少来服务更多的移动节点。或者，优先级可以手动配置。

主机代理生命周期字段的长度也为 2 字节。它表示此 HA 的生命周期，单位为秒。默认值对应于基本路由器广告头中的值。最大可能值为 18.2 小时。值为 0 不被接受。HA 生命周期字段仅与此路由器的 HA 服务相关，因此仅能出现在 H 位（主机代理）设置的路由器广告中。

## 移动 IPv6 通信

本节讨论了移动 IPv6 术语，并深入探讨了通信过程的细节。

### 绑定缓存

每个通信节点和主机代理都会为其每个全局 IPv6 地址维护一个绑定缓存。它列出所有拥有绑定的移动节点。如果它想将数据发送到某个目的地，它会首先在其绑定缓存中查找，然后在目标缓存中查找地址。

绑定缓存条目携带以下信息：

+   用于该条目的移动节点的主机地址。此字段用于在发送数据包时确定目标地址。

+   由主机地址字段指示的移动节点的临时地址，位于此绑定缓存条目中。

+   绑定的生命周期值。

+   一个标志，指示此条目是否为主机注册条目。仅出现在充当主机代理的节点上。

+   针对此主机地址接收到的所有先前绑定更新的序列号字段的最大值。

+   此条目的使用信息。

### 绑定更新列表

每个移动节点维护一个绑定更新列表。该列表包含移动节点发送给其家乡代理和通信节点的每个绑定更新条目，前提是其生命周期尚未过期。如果它发送了多个绑定更新，则只列出具有最高序列号的最后一条消息。

绑定更新列表包含以下信息：

+   绑定更新已发送的节点的 IPv6 地址

+   绑定更新已发送的家乡地址

+   该绑定更新中指示的外部地址

+   绑定更新中指示的生命周期

+   绑定的剩余生命周期

+   该绑定的最高使用序列号

+   绑定更新发送的时间

+   需要重传的状态

+   一个标志，指示是否需要向该目标发送进一步的绑定更新

### 返回可路由性程序

返回可路由性程序的设计目的是让通信节点检测移动节点是否可以在其外部地址和家乡地址上都能被访问。只有当这一点成功验证后，*路由优化*（即通信节点与移动节点之间的直接通信）才可使用。移动节点能在两个地址上被访问，表明它确实在外部链路上，并且已为家乡地址进行了有效注册。这降低了（但并不消除）该绑定更新为安全攻击的风险。只有在成功通过返回可路由性测试后，通信节点才会接受来自移动节点的绑定更新，并直接向移动节点的外部地址发送数据报文。

返回可路由性程序的消息流程包括以下步骤（关于 MH 类型，请参见表 8-1）：

1.  移动节点通过家乡代理向通信节点发送“家乡测试初始化”消息（MH 类型 1）。该消息携带家乡初始化 Cookie。通过这种方式，通信节点得知了移动节点的家乡地址。

1.  移动节点发送“外部地址测试初始化”消息（MH 类型 2）给通信节点。该消息携带外部初始化 Cookie，并直接发送给通信节点（而非通过家乡代理）。通过这种方式，通信节点得知了移动节点的外部地址。

1.  通信节点对“家乡测试初始化”消息进行回复，并通过家乡代理发送“家乡测试”消息（MH 类型 3）。该消息携带家乡初始化 Cookie、家乡密钥生成令牌和家乡随机数索引。移动节点现在可以生成家乡密钥生成令牌。

1.  通信节点对“外部地址测试初始化”消息进行回复，并发送到移动节点的外部地址，回复为“外部地址测试”消息（MH 类型 4）。该消息包含外部初始化 Cookie、外部密钥生成令牌和外部随机数索引。移动节点现在可以生成外部密钥生成令牌。

一旦移动节点接收到家庭测试和 Care-of 测试消息，返回可达性过程就完成了。移动节点将这两个令牌哈希，并创建一个 20 字节的管理密钥，显然该密钥也为最初生成这两个令牌的对应节点所知。此密钥将由移动节点用于保护绑定更新到对应节点。经过安全检查成功后，对应节点可以接受绑定更新，因为移动节点已经证明它在绑定更新中包含的家庭地址和 Care-of 地址是可达的。

RFC 4225《移动 IP 版本 6 路由优化安全设计背景》概述了在定义返回可达性过程时所做的安全性考虑和选择。该信息性文档的目的是帮助 MIPv6 实现者理解设计选择，并帮助设计多宿主解决方案的人员避免一些常见的安全陷阱。详细讨论了安全问题和可能的对策。

### 家庭代理操作

当移动节点离开家庭时，HA 必须拦截所有发送到移动节点的数据包，并将其隧道到移动节点的 Care-of 地址。它通过代理邻居发现来实现这一点。

#### 代理邻居发现

为了拦截发送到家庭链路上移动节点的数据包，HA 必须假装成移动节点。HA 向所有节点组播地址发送邻居广告，提供它自己的链路层地址作为移动节点家庭地址的链路层地址。ND 消息包含以下信息：

+   邻居广告中的 IPv6 头部的源地址是 HA 的地址。

+   ND 消息中的目标地址字段携带移动节点的 IPv6 地址。

+   ND 广告包含一个目标链路层地址选项，携带 HA 的链路层地址。

+   路由器标志（R-Flag）必须设置为 0。

+   必须设置覆盖标志（O-Flag）。链路上的所有节点将更新其邻居缓存，并存储链路层地址。

现在，HA 接收到所有发送到移动节点 IPv6 地址的链路上的数据包。HA 充当移动节点的代理。它必须检查所有收到的邻居请求，并验证目标地址字段是否与其绑定缓存中的家庭注册条目对应。如果是，它会通过邻居广告回复，指出它自己的链路层地址作为移动节点的链路层地址。此过程还保护了移动节点的家庭地址，防止其他家庭链路节点试图配置该地址（即，重复地址检测）。

### 注

有关邻居发现以及提到的 ND 消息和过程格式的更多详细信息，请参阅第四章。

#### 双向隧道

为了转发发送到移动节点家庭地址的数据包，HA 使用 IPv6 隧道。它插入一个额外的 IPv6 头，称为隧道头。隧道头中的源地址是 HA 的 IPv6 地址，目标地址是移动节点的主要 Care-of 地址。移动节点处理隧道头并将解封装后的数据包转发到上层协议和应用程序。

为了在离家时接收组播数据包，移动节点必须注册这些组成员资格。有两种方式可以实现：

+   移动节点可以使用其 Care-of 地址向主链路上的本地路由器注册。在这种情况下，它可以直接接收组播数据包。如果移动节点移动到另一个外部网络，这些成员资格将失效。

+   移动节点可以通过向其 HA 发送 MLD 注册请求，在其主链路上注册组播组成员资格，HA 会通过隧道将组播数据包转发到移动节点。这无论移动节点更换网络多少次，始终有效。

以下数据包不会转发到移动节点：

+   发送到移动节点链路层地址的数据包。这些数据包将以 ICMPv6 目标不可达消息响应。

+   发送到移动节点站点本地地址的数据包。（站点本地地址在发布移动 IPv6 规范后已被弃用；此项将在未来版本的 RFC 中删除。）

+   发送到链路本地、站点本地或组织本地范围的组播数据包。

通过反向隧道从移动节点发送到 HA 的数据包会被 HA 解封装，并通过常规路由机制转发到目标。

当 HA 本身向移动节点发送数据时，它的行为像一个普通的对应节点，这意味着它不使用隧道，而是插入一个路由头类型 2，携带移动节点的家庭地址。

### 移动节点操作

只要移动节点在家庭网络中，就不需要使用移动 IPv6 机制。如果移动节点离家，它同时使用家庭地址和 Care-of 地址。对于每次通信，它必须选择使用哪个地址。IP 层之上的应用和进程通常使用移动节点的家庭地址进行通信。

如果通信需要在移动节点迁移到另一个网络后继续进行，必须使用家庭地址。一旦移动节点与一个有绑定的对应节点建立通信，通信就可以直接路由。如果没有绑定，所有数据都将通过家庭代理隧道传输。对于某些特定的、新的通信，移动节点也可以选择使用其 Care-of 地址，而不依赖于移动 IPv6 功能，就像普通的单播地址一样。当移动节点与外部网络中的本地节点进行通信时，例如进行邻居发现时，它应直接通信，而不使用家庭地址目标选项。

最佳通信路径和相应地址的选择取决于应用程序的要求，这就是决策必须做出的地方。这个定义并不是移动 IPv6 规范的一部分。

#### 路由优化详细信息

当一个不在家庭网络中的移动节点与其有绑定的通讯节点进行通信时，它会使用称为路由优化的过程。

移动节点执行以下步骤：它检查其绑定更新列表，查找此通讯节点的家庭地址条目。这样可以验证通讯节点是否能够处理家庭地址目标选项。然后，它检查绑定更新列表中的以下内容：

+   检查它想要使用的源地址是否与条目中的家庭地址相对应。

+   检查它想要使用的目标地址是否与条目中通讯节点的地址相对应。

+   检查其当前的暂时地址（Care-of address）是否列为该条目的暂时地址。

+   检查绑定是否有效，并且生命周期是否大于零。

如果满足所有这些要求，移动节点就知道通讯节点拥有一个有效的绑定缓存条目。从移动节点发送到该通讯节点的数据包包含以下信息：

+   IPv6 头中的源地址字段包含暂时地址。

+   数据包携带一个目标选项头，内含一个家庭地址选项，包含移动节点的家庭地址。

接收此数据包的通讯节点将从目标选项头中复制家庭地址到 IPv6 头的源地址字段，然后再将数据包传递给上层协议和应用程序。对于上层协议和应用程序来看，数据包似乎是从移动节点的家庭地址发送的。当通讯节点想要向一个移动节点（MN）发送数据时，它会检查其绑定缓存中是否有该目标的条目。如果存在该条目，它会插入一个路由头类型 2。

当通讯节点回复时，地址的使用方式如下：

+   IPv6 头中的目标地址包含移动节点的暂时地址。

+   数据包包含一个路由头类型 2。路由头中的地址字段包含移动节点的家庭地址。

+   移动节点将 IPv6 头中的目标地址字段中的地址与从路由头中复制的家庭地址交换，减少路由头中的剩余段字段（Segments Left）值，将其设置为零，并将数据包传递给上层协议和应用程序。对于上层协议来看，数据包似乎是已发送到移动节点的家庭地址。

图 8-5 展示了移动节点（MN）与通讯节点（CN）之间的通信，以及与路由优化相关的具体头信息。

![带路由优化的头部信息](img/ipv6_0805.png)图 8-5. 带路由优化的头部信息

此图说明了前面描述的过程。移动 IPv6 的主要目标是让 MN 在从一个网络移动到另一个网络时，保持对服务和应用的连接。路由优化的目标是允许 MN 和对应节点之间进行直接路由。通过使用目标选项和路由类型 2 头部，两个节点可以像直接与 MN 在其主机链路上通信一样，在内部处理数据包。因此，对于应用程序来说，看起来就像移动节点仍然在其主机链路上。

这解释了为什么 IPv6 移动性更具可扩展性，并且更适合广泛的移动性应用。扩展头部架构支持路由优化。试想成千上万的移动节点通过其主机代理与对应节点通信。如果所有流量都通过主机代理，主机代理将成为瓶颈、单点故障，并且主机链路将不必要地过载。在许多情况下，从移动节点到对应节点的路由要比经过主机代理的路由短得多。

#### 双向隧道通信

如果 MN 想与没有绑定的对应节点通信，它将使用反向隧道机制。在这种情况下，数据包通过主机代理的隧道发送。原始数据包中的源地址携带 MN 的主机地址，而对应节点的地址作为目标地址。该数据包被封装在另一个 IPv6 头部中，源地址字段携带 MN 的 Care-of 地址，目标地址字段携带主机代理的 IPv6 地址。主机代理处理第一个头部并将原始数据包转发给对应节点。图 8-6 说明了头部信息。

![带双向隧道的头部信息](img/ipv6_0806.png)图 8-6. 带双向隧道的头部信息

#### 移动检测

移动节点（MN）如何检测自己已经移动到另一个网络？移动检测基于邻居不可达检测（NUD；详见第四章）。通过使用 NUD，MN 可以检测到其默认路由器不再可用。在这种情况下，MN 会尝试寻找新的默认路由器。它会对其链路本地地址进行重复地址检测（DAD），根据路由器广告选择新的默认路由器，并基于路由器前缀构建新的 Care-of 地址。当新的地址初始化时，它首先与主机代理执行绑定更新，然后与所有有绑定的对应节点进行更新。

新路由器通告新前缀的事实并不一定是移动节点处于新网络的标志。可能是当前网络中的新路由器或前缀发生了变化。必须定义程序，以防止移动节点在未移动到其他网络时不必要地更新所有绑定。到目前为止，已定义以下程序：

+   如果移动节点收到来自新路由器的带有新前缀的路由公告，但其默认路由器仍然可达，它将不会执行任何绑定更新。它使用邻居可达性检测（NUD）来检测默认路由器是否仍然可用。

+   路由公告（RAs）可以携带广告间隔选项。这允许移动节点根据不同路由公告中的间隔比较来检测此路由器是否仍然可用。

+   如果默认路由器未响应邻居请求（Neighbor Solicitation），移动节点应执行多播路由请求（Multicast Router Solicitation）。

RFC 5568，"移动 IPv6 快速切换"，描述了对移动 IPv6 规范的更新，以减少切换延迟。为此目的定义了新的 ND 消息类型。

#### 返回家园

当移动节点检测到自己已经回到家乡链接时，它向家乡代理发送绑定更新，通知其已回到家中，并且家乡代理不再需要通过隧道转发数据包。这被称为注销绑定更新，只有在注销之后，移动节点才能使用其家庭地址发送和接收数据包。

该家庭注册如下所示：

+   必须设置 A 位（确认）和 H 位（家庭注册）。

+   Lifetime 字段设置为 0。

+   Care-of 地址必须与家庭地址相同。

+   IPv6 头部中的源地址必须是移动节点的家庭地址。

## 安全

如果家乡代理和移动节点之间的数据流未加密，则可能面临许多攻击的可能性，例如中间人攻击、劫持或拒绝服务攻击。

为了保护家乡代理和移动节点之间的隧道，配置了 IPsec 隧道。移动 IPv6 消息需要 IPsec ESP。移动 IPv6 规范对此进行了详细说明。

以下数据流必须进行保护：

+   移动节点（MN）和家乡代理（HA）之间的绑定更新和绑定确认

+   在返回可路由性过程（Return Routability Procedure）期间，通过家乡代理发送的家庭测试初始化和家庭测试消息

+   用于前缀发现的移动节点（MN）和家乡代理（HA）之间的 ICMPv6 消息

移动节点和家乡代理之间的所有控制消息都需要认证、完整性、正确的顺序和防重放保护。此保护需要家乡代理和移动节点之间的安全关联（SA）。IPsec 不提供任何控制消息顺序的手段。正确的顺序由绑定更新和确认消息中的序列号提供。仅当使用互联网密钥交换（IKE）时，才能提供更强的重放攻击保护。

### 注意

有关安全术语和概念的描述，请参见第六章。

移动节点与对应节点之间的绑定更新通过在返回路由能力过程（Return Routability Procedure）中建立的安全关联（SA）进行保护。移动节点与对应节点之间的绑定更新还必须通过绑定授权数据选项进行保护。此选项包括一个绑定管理密钥，该密钥是在返回路由能力过程中生成的。

关于移动 IPv6 的安全性方面及机制的更详细讨论，可以参见 RFC 6275（《IPv6 中的移动支持》）、RFC 3776（《使用 IPsec 保护移动节点与家庭代理之间的移动 IPv6 信令》）、RFC 4877（《使用 IKEv2 和修订版 IPsec 架构的移动 IPv6 操作》），以及一般的安全性 RFC。

RFC 4285，《移动 IPv6 认证协议》为 3GPP2 网络中的 MIPv6 消息提供了一种安全机制。它是一个信息性 RFC，没有经过 IETF 的审查，包含一个专为 MIPv6 设计的移动性消息认证选项，可添加到 MIPv6 信令消息中。

## 移动 IPv6 扩展

为了使移动 IPv6 更加灵活和可扩展，已定义了若干扩展。以下部分将对这些扩展进行描述。

### NEMO

移动 IPv6 的扩展——网络移动（NEMO）已在 RFC 3963 中定义。NEMO 基本支持协议使得移动网络可以连接到互联网上的不同节点。它使得移动网络中的每个节点在移动路由器改变其附着点时，仍能保持会话连续性。它还允许移动网络中的每个节点在移动时仍然可达。该解决方案支持既支持移动性的移动节点，也支持在移动网络中不支持移动性的主机。

该过程和消息与移动 IPv6 基本相同，不同之处在于，此时移动节点是一个*移动路由器*。在当前的 NEMO 规范中，移动网络中的节点与对应节点之间的通信始终通过家庭代理进行。路由优化尚未定义。从理论上讲，可以配置嵌套的移动性，其中一个移动路由器允许另一个移动路由器连接到其移动网络。这为许多高移动性的场景打开了新的可能性。一个应用案例可能是车载通信，车中的路由器可以作为移动路由器。未来我们将看到如何使用这些技术，过去几年中的发展表明，有时意想不到的应用会在一夜之间出现并广泛使用。

### 分层移动 IPv6

随着 RFC 5380《分层移动 IPv6》的发布，移动 IPv6 的可扩展性得到了进一步扩展。该设计旨在显著提升移动 IPv6 的性能，并减少移动节点在链路上传输更新其与家庭代理和对应节点绑定的消息的次数。它还允许移动节点在使用路由优化时，隐藏其位置，避免暴露给对应节点和家庭代理。

分层移动 IPv6 引入了一种新的节点类型——*移动锚点*（MAP）。MAP 可以位于分层网络中的任何路由器位置。它本质上是移动节点所在地理区域的本地家庭代理。移动节点现在将绑定更新消息发送到本地 MAP，而不是家庭代理和通信节点。通过向 MAP 发送一次绑定更新消息，所有来自家庭代理和通信节点的后续流量将被重新路由到移动节点的新位置。家庭代理和通信节点的操作不会受到影响，因此无需进行任何更改。图 8-7 说明了这一概念。

![分层移动 IPv6](img/ipv6_0807.png)图 8-7. 分层移动 IPv6

当移动节点进入 MAP 域时，它会接收到包含一个或多个本地 MAP 信息的路由器广告（MAP 选项）。MAP 的*区域关怀地址*（RCoA）对应于基础 MIPv6 规范中的关怀地址。在与 MAP 注册后，移动节点将其 RCoA 注册到其家庭代理，并最终注册到当前的通信节点。RCoA 现在被用作移动节点的关怀地址。它是家庭代理和通信节点用于与远离家庭的移动节点通信的地址。当移动节点在 MAP 域内从一个网络移动到另一个网络时，它会将新的*链路本地关怀地址*（LCoA）注册到 MAP。MAP 作为本地家庭代理，代表移动节点接收所有数据包，并将其封装并转发到移动节点的当前地址。图 8-7 中的接入路由器（AR1 和 AR2）定义了 MAP 域的边界。这显著提高了移动 IPv6 的性能，因为每次移动节点在 MAP 域内切换到另一个网络时，绑定更新不必再发送到家庭代理和通信节点。

如绑定更新消息部分所述，绑定更新消息中新增了一个位——M 位，用于指示这是一个 MAP 注册，而非与家庭代理的绑定更新。此外，邻居发现协议也进行了扩展，以包括 MAP 的全局 IPv6 地址。

MAP 可以存在于分层网络中的任何位置。多个 MAP 可以独立地位于同一域内。此外，允许并推荐重叠的 MAP 域。支持静态和动态层级结构。

### 代理移动 IPv6

代理移动 IPv6 是一种基于网络的移动性管理协议。它在 RFC 5213 中进行了定义，并在网络层提供移动性管理，这意味着网络组件接管了处理移动性消息的工作。

这些元素包括*本地移动锚点*（LMA）和*移动接入网关*（MAG）。LMA 负责管理 MN 及其家庭前缀的可达性。LMA 具有 MN 的拓扑锚点功能。MAG 管理 MN 的移动性。MAG 位于 MN 的接入网络上，负责 MN 的移动以及与 LMA 的绑定消息的发起。在一个移动 IPv6 域中可以有多个 LMA，每个 LMA 可以管理不同的 MN 组。

或者，可以使用本地路由（RFC 6705）允许连接到 MAG 的节点通过使用本地转发或网关之间的直接隧道直接交换流量。

### 多个 Care-of 地址注册

如果 MN 具有多个活动接口，它只能将其中一个 Care-of 地址与其家庭地址绑定。RFC 5648 中的规范定义了支持将多个 Care-of 地址与家庭地址绑定的扩展。每个 MN 创建的绑定都会生成一个新的*绑定标识号*（BID），并将其包含在绑定更新中。HA 为每个 BID 创建一个单独的绑定，并相应地将其存储在绑定缓存中。相同的机制也适用于与 CN 的绑定消息。

### 流绑定

上述多个 Care-of 地址注册允许将多个 CoA 与家庭地址进行绑定。通过 RFC 6089 中的流绑定规范，可以为每个绑定关联不同的策略。这也适用于与 CN 或 MAP 的绑定。

### 快速切换

在 RFC 5568 中，指定了一种协议，用于减少移动节点从一个网络移动到另一个网络时的切换延迟。它被称为“移动 IPv6 的快速切换”。切换操作包括移动检测、地址配置和地址更新。综合切换延迟通常足以影响实时应用（例如 VoIP）。此规范描述了一组协议和程序，以显著减少切换延迟。所有对吞吐量敏感的应用都能从快速切换中受益。

RFC 4260《802.11 网络的移动 IPv6 快速切换》讨论并给出了一些关于在 802.11 网络上实施移动 IPv6 快速切换的例子。

### 支持双栈主机和路由器

原始的移动 IPv6 和 NEMO 规范仅描述了使用 IPv6 进行移动性。RFC 5555 扩展了这一点，允许 IPv4 地址和前缀的注册，并且还允许 IPv4 和 IPv6 数据包通过隧道传输到 HA。MN 可以从 IPv4 网络移动到 IPv6 网络，反之亦然，即使 MN 与 HA 之间的路径中存在 NAT。

现在你已经阅读完本书中的技术章节。第九章将所有内容整合在一起，解释了规划和设计未来网络的关键。它整合了超过 10 年的经验、教育和咨询，结合了许多基于最佳实践的建议。

## 参考文献

以下是本章提到的最重要的 RFC 和草案列表。有时我还会提供一些与主题相关的额外 RFC，供你个人进一步学习。

### RFCs

+   RFC 2710, “IPv6 的多播监听发现（MLD）”，1999

+   RFC 3776, “使用 IPsec 保护移动节点与主代理之间的移动 IPv6 信令”，2004

+   RFC 3963, “网络移动性（NEMO）基本支持协议”，2005

+   RFC 4065, “Seamoby 和实验性移动协议 IANA 分配的说明”，2005

+   RFC 4140, “分层移动 IPv6”，2005

+   RFC 4225, “移动 IPv6 路由优化安全设计背景”，2005

+   RFC 4260, “802.11 网络上的移动 IPv6 快速切换”，2005

+   RFC 4282, “网络接入标识符”，2005

+   RFC 4283, “移动 IPv6（MIPv6）的移动节点标识符选项”，2005

+   RFC 4285, “移动 IPv6 的认证协议”，2006

+   RFC 4303, “IP 封装安全负载（ESP）”，2005

+   RFC 4306, “互联网密钥交换（IKEv2）”，2005

+   RFC 4449, “使用静态共享密钥保护移动 IPv6 路由优化”，2006

+   RFC 4487, “移动 IPv6 与防火墙：问题陈述”，2006

+   RFC 4555, “IKEv2 移动性和多宿主协议（MOBIKE）”，2006

+   RFC 4584, “移动 IPv6 的套接字 API 扩展”，2006

+   RFC 4621, “IKEv2 移动性和多宿主（MOBIKE）协议设计”，2006

+   RFC 4831, “基于网络的本地化移动性管理（NETLMM）目标”，2007

+   RFC 4866, “移动 IPv6 的增强路由优化”，2007

+   RFC 4877, “与 IKEv2 和修订后的 IPsec 架构一起操作的移动 IPv6”，2007

+   RFC 4885, “网络移动性支持术语”，2007

+   RFC 4887, “网络移动性家庭网络模型”，2007

+   RFC 4908, “使用移动 IP 和 NEMO 的小规模固定网络多宿主”，2007

+   RFC 5094, “移动 IPv6 厂商特定选项”，2007

+   RFC 5096, “移动 IPv6 实验消息”，2007

+   RFC 5142, “移动性头主代理切换消息”，2008

+   RFC 5149, “移动 IPv6 服务选择”，2008

+   RFC 5164, “移动性服务传输：问题陈述”，2008

+   RFC 5213, “代理移动 IPv6”，2008

+   RFC 5270, “IEEE 802.16e 网络上的移动 IPv6 快速切换”，2008

+   RFC 5271, “3G CDMA 网络上的移动 IPv6 快速切换”，2008

+   RFC 5380, “分层移动 IPv6（HMIPv6）移动性管理”，2008

+   RFC 5555, “移动 IPv6 对双栈主机和路由器的支持”，2009

+   RFC 5568, “移动 IPv6 快速切换”，2009

+   RFC 5637, “移动 IPv6 的认证、授权和计费（AAA）目标”，2009

+   RFC 5648, “多个 Care-of 地址注册”，2009

+   RFC 5844, “IPv4 支持代理移动 IPv6”，2010

+   RFC 5846, “IPv6 移动性绑定撤销”，2010 年

+   RFC 5847, “代理移动 IPv6 的心跳机制”，2010 年

+   RFC 5944, “IPv4 的 IP 移动性支持”，2010 年

+   RFC 6089, “移动 IPv6 和网络移动性（NEMO）基本支持中的流绑定”，2011 年

+   RFC 6275, “IPv6 中的移动性支持”，2011 年

+   RFC 6279, “代理移动 IPv6（PIMPv6）本地化路由问题陈述”，2011 年

+   RFC 6463, “代理移动 IPv6 的运行时本地移动锚点（LMA）分配支持”，2012 年

+   RFC 6543, “代理移动 IPv6 的保留 IPv6 接口标识符”，2012 年

+   RFC 6572, “代理移动 IPv6 的 RADIUS 支持”，2012 年

+   RFC 6610, “移动 IPv6（MIPv6）中的主信息发现的 DHCP 选项”，2012 年

+   RFC 6611, “移动 IPv6（MIPv6）集成场景的引导过程”，2012 年

+   RFC 6618, “使用传输层安全性（TLS）进行移动节点与主代理之间通信的移动 IPv6 安全框架”，2012 年

+   RFC 6705, “代理移动 IPv6 的本地化路由”，2012 年

+   RFC 6909, “代理移动 IPv6 的 IPv4 流量卸载选择器选项”，2013 年

+   RFC 7077, “代理移动 IPv6 的更新通知”，2013 年

+   RFC 7109, “由主代理发起的移动 IPv6 流绑定”，2014 年

+   RFC 7148, “代理移动 IPv6 的前缀委派支持”，2014 年

+   RFC 7156, “Diameter 对代理移动 IPv6 本地化路由的支持”，2014 年

+   RFC 7161, “通过 LMA（SIAL）获取订阅信息的代理移动 IPv6（PMIPv6）组播切换优化”，2014 年

+   RFC 7222, “代理移动 IPv6 的服务质量选项”，2014 年
