## 第九章：IPv6 规划

在前面几章从技术角度描述了 IPv6 的特点之后，本章将所有内容汇总起来。

它总结了我在学习、工作、娱乐、教学和为 IPv6 提供咨询的 10 多年里所学到的一切。它为您提供了所有相关的内容，帮助您理解规划 IPv6 集成所需的知识。它也是我在与客户交流时，回答最常见问题的总结。希望能让您对 IPv6 所带来的机会感到一些兴奋。所以，我祝您阅读愉快，并在学习和规划 IPv6 时收获乐趣。

虽然在较大网络中进行集成确实会遇到一些挑战，并且需要大量时间和仔细规划，但不需要惊慌，也不用认为这无法掌握。每一个掌握了 DHCP、VPN 和 NAT 引入的合格工程师，也能掌握 IPv6 的引入。主要的不同点在于 IPv6 作为传输协议几乎涉及到网络中的每一个组件，因此复杂性来自于考虑不同网络组件、服务和部门之间的所有交互。挑战主要体现在组织层面、未来架构的设计，以及所有团队和网络、应用程序各部分之间的相互依赖关系。

但这个过程可以分解为单个可执行的步骤，并且如果足够提前开始，完全不需要在三个月内完成。本章提供了一个大纲，帮助您确定如何进行。

## 何时选择 IPv6？

一条黄金法则是“永远不要触碰一个正在运行的系统。”这条规则同样适用于您的 IPv4 网络。只要它们能正常工作，就让它们继续运行。但是，当 IPv4 网络因某些原因达到限制，或者当需要进行升级时，选择 IPv6。IPv6 已经足够成熟，可以在企业和商业网络中使用，正如全球许多案例研究和部署所展示的那样。如果可能，应该避免在新的 IPv4 设置、修复或复杂的 IPv4 配置（特别是 NAT）上进行高额投资，因为它们是在一个将被逐步淘汰的技术上进行的投资，而这个技术实际上已经进入了生命周期末期。提前熟悉新协议，在真正需要它之前花一些时间进行实验，并提前规划，将为您节省大量成本、时间和麻烦。

### 注意

无论您在 IPv6 上的投资如何，它都是对未来技术的投资。而在 IPv4 上的投资则是对一个即将结束生命周期的技术的投资。

如同在第一章中提到的，这里列出了可能是您考虑集成 IPv6 的一些指示：

+   您的 IPv4 网络或 NAT 实现需要修复或扩展。

+   计划中的重大硬件升级或重新设计。为 IPv6 重新设计，并根据需要支持 IPv4。

+   您的地址空间即将用尽。

+   你想为可能突然需要 IPv6 支持的收购做好网络准备。

+   你想为基于 IPv6 高级特性的应用程序准备网络。

+   你需要为大量用户提供端到端安全性，但没有足够的地址空间，或者在 NAT 实现上遇到困难。

+   你的硬件（骨干网、DMZ、数据中心等）或应用程序已经到达生命周期的尽头，必须更换。确保你购买支持 IPv6 的产品，即使你不会立即启用它。为了确定你的产品需要的支持水平，你需要有一个 IPv6 战略。

## 集成场景

正如本章对不同技术的讨论所示，存在许多机制支持逐步引入 IPv6。没有一种机制可以覆盖所有需求，或者在所有场景中都最优。在大多数情况下，会选择不同机制的组合。最佳组合和顺序取决于当前环境的基础设施以及过渡/集成的目标和要求。在 IETF 中，基础协议的工作已经完成。他们现在专注于为不同类型的环境开发实际场景，结果已发布。我们在此提供一个总结，目的是提供思路，供你根据自己的需求加以应用，而非为你的环境提供操作手册。

### 注意

如果你想了解 IPv6 运维工作组的最新动态，可以参考 [`www.ietf.org/html.charters/v6ops-charter.html`](http://www.ietf.org/html.charters/v6ops-charter.html) 和 [`www.ietf.org/html.charters/6man-charter.html`](http://www.ietf.org/html.charters/6man-charter.html)。

### 组织

将单一主机或小型网络与 IPv6 Internet 连接并不是一个大挑战，可以通过原生支持（如果你的 Internet 提供商提供此服务）或者使用前面描述的某些隧道机制来实现。大多数操作系统都可以轻松实现此连接。

如果你需要隧道，拥有公共 IPv4 地址，并且想要访问 IPv6 Internet，可以使用 6rd 或 Tunnel Broker。如果你已启用 NAT 并使用私有 IPv4 地址，你可以选择使用 Proto 41 转发，只要 NAT 设备支持此功能。那些有幸得到提供商提供原生 IPv6 连接的组织可以拥有双栈互联网连接。如果你的设备和操作系统支持 IPv6（如果它们是最新版本，肯定支持），那么双栈通常是最简单的方式。

许多组织有多个 IPv4 虚拟局域网（VLAN）。在这种情况下，IPv6 路由器可以将一个单一的 IPv6 前缀通告到所有支持双栈通信的 VLAN 中。然而，这仅建议作为过渡期使用。在这些 VLAN 中的所有 IPv6 节点可以通过 IPv6 路由器通告的前缀进行自动配置 IPv6 地址。

隧道机制不仅支持通过 IPv4 互联网传输 IPv6，还支持在 IPv4 骨干网上内部传输 IPv6。骨干网升级并不是你每年都会选择做的事情；你可能希望等到骨干路由器生命周期结束后再进行改动。这并不妨碍在网络边缘推广 IPv6。只要骨干网基于 IPv4，IPv6 数据包就会被隧道化到另一端的 IPv6 岛屿。

如果你希望将 IPv6 集成到一个更复杂的 DMZ 中，用于你的公共服务和/或内部网络，包括多个位置、可能有多个数据中心，以及整个网络中使用的不同类型的应用程序和服务，你需要定义一个企业过渡战略。有关更多细节，请参见规划 IPv6 章节。

RFC 4057《IPv6 企业网络场景》可以帮助你迈出第一步。它描述了 IPv6 在企业网络中的不同部署场景，并提供了如何着手这一任务的指导和检查表。该 RFC 中涵盖了以下场景：

+   在 IPv4 的配合下部署 IPv6。

+   因为一组特定的应用需要通过 IPv6 网络使用，所以部署 IPv6。

+   构建一个新的网络或重组现有的网络，并在企业内部以 IPv6 作为主要协议与 IPv4 共存。

文档接着回顾了企业中常见的几种网络基础设施组件，这些组件必须进行分析。

RFC 4852《IPv6 企业网络分析——IP 层 3 重点》基于 RFC 4057，分析了企业网络向 IPv6 过渡的情况，重点讨论了 RFC 4057 中给出的场景中的第 3 层。文中有一个表格，概述了不同的场景，然后在文中讨论了如何应对每个场景以及可能的过渡机制。请注意，这份 RFC 写于 2007 年。在某些章节中提到了 ISATAP、6to4 和 Teredo 等机制。我们强烈建议你不要在生产环境中使用这些机制，而是用更新的技术来替代它们。

### ISPs

IPv6 的设计旨在帮助互联网服务提供商（ISPs）应对互联网的指数级增长挑战，使其能够为客户提供新的服务。在未来几年内，设备数量将激增，而这一挑战只能通过 IPv6 的地址空间来解决。电缆、DSL、无线以及其他始终在线的技术也可以从 IPv6 的地址空间中受益。IPv6 的其他优势包括增强端到端安全性和移动通信的能力，以及减轻系统管理负担。举例来说，包括无需 NAT 穿越问题的点对点通信、能够安全地在家里访问工作中的设备和应用程序或反之亦然、增强的 IP 移动性等。

因此，ISP 必须评估 IPv6 能否满足这些需求。一些国家在这一领域处于领先地位，从测试和评估阶段转向了 IPv6 在宽带领域的实际部署。日本就是一个典型例子，此外还有其他国家正在考虑向大规模生产部署 IPv6 迈进。自 2011 年 IPv4 地址池耗尽以来，许多欧洲和美国的大型服务提供商也已开始部署 IPv6。

### 注意

在全球范围内，IPv6 中继 AS（自治系统）的数量大幅增加。[截至 2014 年，全球前 300 名中继 AS 中有超过 80% 支持 IPv6](http://6lab.cisco.com)。

在未来几年，ISP 将不得不同时提供 IPv4 和 IPv6 服务。在第一阶段，为客户提供 IPv6 网络接入（只要其骨干仍为 IPv4）时，可以使用隧道机制。许多大型 ISP 选择使用 6rd，这是一种基于 6to4 的机制，但提供了更多或更少的原生性能（参见 第七章 中的 6rd 部分）。这是一种更简单、更经济的方式来开始提供 IPv6 服务。根据客户的需求和要求，原生 IPv6 部署选项可能具有更好的可扩展性，并提供更好的服务性能。你可能可以利用下一个骨干升级周期并引入双栈。所有其他服务，如网页托管、电子邮件和 FTP，最好同时支持这两种协议（IPv4 和 IPv6）。迁移步骤应当精心规划，选择并实施有效的机制组合。ISP 的主要目标是通过这两种协议提供所有服务：这是覆盖整个市场的唯一途径。尤其对于 ISP 来说，引入 IPv6 提供了创造商业机会和新服务的可能性。作为客户，你在购买互联网服务时希望得到双栈支持，因为只有双栈才能让你成为两个互联网（IPv4 和 IPv6）的完整成员。

RFC 4029，《将 IPv6 引入 ISP 网络的场景与分析》，分析了 ISP 面临的挑战和机遇，并讨论了不同的集成和过渡场景，内容分为骨干过渡行动、客户连接过渡行动以及网络和服务运营行动。RFC 4779，《宽带接入网络中的 ISP IPv6 部署场景》，介绍了在宽带服务提供商网络接入部分部署 IPv6 服务的可选方案，即电缆/HFC、宽带以太网、xDSL、WLAN 和 PLC/BPL。它简要讨论了提供商网络的其他元素，并为每种先前提到的宽带技术提供了不同的可行的 IPv6 部署与集成技术和模型。RFC 5181，《802.16 网络中的 IPv6 部署场景》，扩展了讨论，并深入探讨了无线宽带接入网络的部署场景。

一些互联网服务提供商（ISP）回避部署 IPv6，希望通过扩展其 NAT 和实施 CGN 来应付。思科委托进行的一项 IDC 研究分析了一个拥有 500 万家庭用户的 ISP 在 5 年内的资本支出（capex），并比较了仅部署 CGN 的情境与同时部署 6rd 和 CGN 的情境。研究表明，同时引入 IPv6 和 CGN 的商业案例要好得多。原因在于原生 IPv6 能够减轻 CGN 的流量负担。随着 IPv6 支持的网站数量增加，6rd 的部署将大大减轻 CGN 的流量负担，从而减少 CGN 端的维护工作。

### 注意

比较结果表明，在 5 年内，选择正确的 IPv6 战略可以使 ISP 节省多达 69%的资本支出投资。如果您对这项研究《现在提供 IPv6 服务的商业案例》感兴趣，可以通过[`bit.ly/1nac2SH`](http://bit.ly/1nac2SH)找到它。

#### 移动网络

长期以来，移动网络中的 IPv6 部署并未发生。早期的智能手机，如曾经流行的索尼爱立信 P900，配备了支持 IPv6 的 Symbian 协议栈。但当时没有任何移动运营商愿意部署 IPv6。

过去两年中，这一状况发生了变化。T-Mobile 美国和 Verizon 无线是两个知名的、经常讨论的 IPv6 部署案例。T-Mobile 在 2014 年就已有数百万 IPv6 用户。其他运营商，如中国移动以及一些欧洲运营商，也已经部署了 IPv6。随着 Android 4.3 及更高版本中 464XLAT 的实现，为移动运营商提供 IPv6-only 服务变得更具吸引力。演示表明，使用 464XLAT 时，IPv4 应用程序可以在 IPv6-only 设备上良好运行。其他智能手机厂商希望尽快加入这一行列。

### 注意

有关 464XLAT 的更多细节，请参见第七章。

RFC 3574 讨论了 3GPP 网络的过渡情境。RFC 4215 则更详细地描述了 3GPP 网络，并且是 RFC 3574 的补充文档。RFC 6459《IPv6 在 3rd Generation Partnership Project (3GPP) Evolved Packet System (EPS)中的应用》描述了不同 3GPP 架构中的 IPv6 支持，RFC 7066《第三代合作伙伴项目（3GPP）蜂窝设备的 IPv6 要求》描述了超出标准 IPv6 节点要求（RFC 6434）的蜂窝设备需求，因为蜂窝链路在带宽、成本和延迟方面的特点对 IPv6 的使用提出了特殊要求。RFC *draft-ietf-v6ops-mobile-device-profile-07*定义了一个 IPv6 配置文件，许多运营商推荐该配置文件以将 3GPP 移动设备连接到 IPv6-only 或双栈无线网络（包括 3GPP 蜂窝网络和 IEEE 802.11 网络）。该配置文件不同于 RFC 7066 中定义的用于连接 IPv6 蜂窝网络的一般配置文件，特别是，它还描述了如何通过 IPv6-only 传输提供 IPv4 连接服务的功能。

#### 家庭网络

在互联网的早期，家庭“网络”由一台配有拨号调制解调器的 PC 组成。连接只有一个单一的 IP 地址。今天，这一场景发生了巨大的变化，随着设备数量和类型的增加，以及内部路由的增多，面临的挑战也在增加。现在，我们将 IPv6 引入其中，这再次增加了复杂性，并需要新的设计、新的地址原则和新的操作措施。

IPv4 和 IPv6 地址架构之间的一个重大区别是，在 IPv6 中，接口可以并且通常会拥有多个地址。它们至少有一个链路本地地址，此外，它们还拥有一个或多个全局单播地址（GUAs），甚至可能有一个唯一本地地址（ULA）。如果一个 homenet 有多个 ISP，该家庭网络可能会通过不同的渠道从每个 ISP 获取 IPv6 前缀（例如，从一个 ISP 获得 6rd /60 前缀，另一个通过 DHCP 前缀委派获得/48 前缀，等等）。因此，网络中的所有设备可能最终会拥有两个 GUAs，每个前缀一个。而家庭网络通常会有多个子网。

有几个新的方面需要考虑。IETF 有一个 homenet 工作组，该小组正在为未来更复杂的家庭网络开发新的架构。homenet 小组正在定义基于 IPv6 的家庭网络的通用架构，并描述相关的原则、考虑因素和要求。他们讨论了引入 IPv6 对家庭网络的具体影响，描述了架构的各个元素，并建议如何在家庭网络中使用标准的 IPv6 机制和地址。该小组在其首份文件《IPv6 家庭网络架构原则》中开发的架构，描述了某些附加功能所需的特定协议扩展。假设 IPv6 家庭网络没有进行主动管理，并且作为 IPv6 仅或双栈网络运行。如果你是 ISP，并且需要设计家庭网络，这个小组的文档无疑是一个良好的资源。

### 注意

你可以在[`bit.ly/1nac5Om`](http://bit.ly/1nac5Om)找到 homenet 小组。

## IPv6 规划

2011 年 2 月，全球 IPv4 地址池耗尽。从 2011 年 4 月开始，APNIC 开始使用最后一个/8 块地址。从 2012 年 9 月开始，RipeNCC 也开始使用最后一个/8 块地址。这一事件成为整个行业的警钟。从那时起，许多大型企业启动了不同程度的 IPv6 项目。许多项目仍处于规划阶段。正如你将在接下来的章节中看到的，对于大型企业，规划和部署可能需要三到五年的时间。

大多数企业已经克服了商业案例的讨论。实施 IPv6 有很多理由，并且应该立即开始。这里的“立即”指的是您必须现在开始规划。一旦您了解了部署 IPv6 所需的工作量、在不同网络和服务区域的时间安排，以及如何设计您的地址计划和安全概念，您可以将这些计划搁置，直到需要启用 IPv6 的那一天。但如果您没有提前规划，等到那一天来临时，您将无法在时间压力下创造出合格且具备操作性的重要设计。

规划和设计 IPv6 在您网络中的集成为您提供了一个独特的机会，可以为您的下一代 IT 环境奠定新的基础。

### 注意

IPv6 提供了一个机会，可以清理现有的不一致，推动标准化，并实施新的架构和操作模式。

启动 IPv6 项目的企业最常见的原因是：

+   业务连续性

+   可达性（来自外部）

+   生命周期管理

+   投资保护

+   教育和积累经验的时间

提前规划有哪些优势？提前规划可以节省很多成本，并且可以充分利用 IPv6 集成所提供的机会。以下是一些优势：

+   利用产品生命周期、更新周期和其他 IT 项目。

+   通过为购买新设备、工具和应用程序，以及谈判外包合同和 SLA 制定明确的 IPv6 要求来保护投资。所有这些都必须进行调整，以便适当覆盖 IPv6 的需求。

+   集成 IPv6 将需要三年或更长时间（主要是为了利用更新周期）。如果您不提前规划，当需要时您将没有准备好。尤其是地址和安全的设计和概念需要大量时间，并应谨慎完成。它们需要更新，以便利用新的地址架构，通常需要进行深入讨论和多次迭代，直到所有 IT 部门都能认同它。通常，安全人员面临最大的挑战，需要时间学习 IPv6 并调整他们的概念。但这也是一个巨大的机会，可以清理并重新设计基于 IPv4 的安全概念。

+   您需要时间来教育所有 IPv6 团队成员和 IT 员工。

+   您想要利用 IPv6 所提供的所有机会！

+   您需要足够的时间进行实验室测试、测试和试点。

+   您需要时间与供应商修复 bug（早期堆栈）。

当您运营一个更大规模甚至是全球性的网络时，大多数 IT 决策者会想知道从哪里开始，以及如何进行。

### 注意

由于 IPv6 的引入涉及到您网络中的每一个方面和设备，这使得这个 IT 项目的规模远远超过了其他任何 IT 项目。

让我为您提供一个快速的 IPv6 规划入门。

### 注意

规划过程的更详细讨论可以在我的配套书籍*《IPv6 规划》（O'Reilly）*中找到。

### 从哪里开始

成功的关键因素之一是 IPv6 项目需要管理层关注，并且需要一位企业级 IPv6 项目经理。网络中的所有设备、服务和各个方面都会受到影响，因此必须拥有全局视角，并意识到接口和依赖关系（无论是组织层面的还是技术层面的）。

第一步：

+   获取管理层的关注。

### 注意

指定一个 IPv6 项目经理，并建立一个 IPv6 过渡办公室。

+   教育参与过程的所有团队。

+   获取整体视角。

+   涉及所有团队。

+   包括业务愿景、业务战略和 IT 战略，并在此基础上制定 IPv6 战略，使其具有可持续性。

+   您的 IPv6 战略应支持业务。

+   制定一个针对 IPv6 项目的沟通和内部营销战略。

以下步骤建议：

*创建您当前状况的布局*

在第一步中，分析您的业务愿景、业务战略和 IT 战略，以及您的 IT 基础设施、IT 服务和项目、硬件和软件的生命周期、工具，以及合同和服务协议。创建流程、政策和标准的概览，并评估 IPv6 集成对所有这些方面的影响。

*定义您的 IPv6 战略*

在第二步中，定义您的目标架构、总体 IPv6 战略，包括高级地址规划和高级安全概念（两者必须相互一致）。接下来，定义路线图，并将其与其他 IT 项目和更新周期对齐。清晰地了解采用计划、里程碑和依赖关系。基于您的 IPv6 设计，为所有类型的设备和应用程序创建 *RFC 要求*。评估您的 *供应商战略*，并检查它是否需要为 IPv6 做出调整。不要假设为 IPv4 表现优秀的供应商也一定适合 IPv6。

*评估当前环境*

根据 RFC 要求，评估您当前的基础设施、硬件和软件、操作系统、应用程序、服务和合同的 IPv6 准备情况。只有现在，您才能根据评估结果确定部署 IPv6 的成本。根据评估中的发现，您可能还需要调整设计或路线图，或两者都需要调整。利用这个机会，在团队中积累 IPv6 经验。

*创建详细的概念和部署计划*

对网络中的所有不同领域，必须创建详细的设计和部署计划，并在实验室和试点中进行测试。所有这些过程可能需要多个迭代。需要为测试、修复漏洞和供应商评估分配足够的时间。同时，不要忘记调整所有相关流程，例如升级测试、所有支持级别、变更管理、安全流程、监控、地址管理等。

*部署并文档化*

如前所述，企业网络中 IPv6 的部署可能需要长达三年甚至五年的时间。你不会一次性在所有领域部署，而是会有一个路线图，并在与其他项目或生命周期对接的特定领域进行部署。因此，最后的步骤，如详细设计、部署计划以及最终部署，通常是针对特定领域执行的。最后，确保所有内容都有良好的文档记录。

### 关于应用程序的一些说明

启用 IPv6 网络是可行的。但只要应用程序没有在 IPv6 上运行，启用 IPv6 的网络也没有太大意义。所以你需要在启用网络的同时，尽早开始处理应用程序。

第三方应用程序通常应在当前版本中启用 IPv6，如果没有，IPv6 支持应在清晰的路线图中列出。与你的供应商沟通，必要时评估替代方案。然而，自主开发的应用程序情况不同。这里你需要区分两种情况：a) 该应用程序仅在内部使用，b) 该应用程序是市场应用程序。在 a)情况下，你可以控制用户如何使用这些应用程序。为市场开发的应用程序应该能够在 IPv4 网络、IPv6 网络以及双栈网络中运行，因为供应商无法控制用户如何访问应用程序。

如果你为市场开发应用程序，重要的是要提前规划，因为这些应用程序通常有很长的生命周期。如果开发人员不了解 IPv6 的影响，应用程序可能根本无法运行，或者无法针对 IPv6 网络进行优化。因此，无论你是自行开发应用程序还是与合作伙伴共同开发，都要确保开发团队接受充分的 IPv6 教育，重点是如何为双栈网络开发，并更新应用程序设计规范以支持未来的 IPv6 网络。如果你购买市场上的定制开发应用程序，你必须特别更新你的 RFC 要求。

本节不是应用程序移植的指南。这里的目的是让你了解你将面临的情况以及需要注意的事项。

你将遇到以下情况：

+   在双栈节点上的 IPv4 应用程序

+   在双栈节点上的 IPv6 应用程序

+   在双栈节点上，支持 IPv4 和 IPv6 的应用程序

+   在仅支持 IPv4 的节点上，支持 IPv4 和 IPv6 的应用程序

+   在仅支持 IPv6 的节点上，支持 IPv4 和 IPv6 的应用程序

开发人员面临的挑战是为市场开发在各种情况下都能良好运作的应用程序。每当需要调用服务时，应该使用 DNS 名称。但是，DNS 回复并不是选择使用哪个协议的可靠指示。例如，一台主机可能是双栈的，并且在 DNS 中有一个带 IPv4 地址的 A 记录和一个带 IPv6 地址的 AAAA 记录。但在这台主机上，可能存在仅支持 IPv4 的应用程序。因此，即使解析主机名返回一个 IPv6 地址，应用程序也无法通过 IPv6 访问。因此，你需要在 DNS 中输入服务名称，并为每个服务配置相应的记录类型（IPv4 服务使用 A 记录，IPv6 服务使用 AAAA 记录）。但如何由 DNS 管理员处理这些问题取决于操作实践，因此不能完全依赖。DNS 请求也可能返回一个 AAAA 记录，但主机可能没有 IPv6 路径连接到它。解析 DNS 名称并获得多个地址的节点应该尝试所有地址，并具备选择最佳性能连接的机制。

### 注意

Happy Eyeballs 是一种旨在帮助解决这一问题的机制，已在不同操作系统和浏览器中实现。有关更多信息，请参阅 第五章 中的 DNS 部分。

以下列表展示了应用程序中最重要的 IP 依赖：

+   IP 地址的格式（32 位点分十进制或 128 位带冒号的十六进制）

+   用于建立连接和数据交换的 API 函数

+   DNS，用于将主机名解析为 IP 地址，反之亦然

+   IP 地址选择，地址的缓存/存储

+   多播应用程序，根据情况；IPv4 和 IPv6 多播地址的对应关系以及正确的套接字配置选项选择

+   一些应用程序将许可控制基于 IPv4 地址

最好的做法是使应用程序与 IP 版本无关。这意味着源代码不应有任何 IP 依赖。通信库应提供没有 IP 依赖的 API。

### 注意

在 RFC 4038《IPv6 过渡的应用方面》中可以找到这些问题的更详细讨论。

东京大学和横河电机公司于 1998 年启动了 TAHI 项目。他们开发了可以供 IPv6 开发者使用的测试工具，用于测试其实现是否符合标准并具备互操作性。这些测试可以免费使用。这是他们为 IPv6 高效开发和部署做出的贡献。测试结果也免费提供给开发者社区。在 [TAHI 网站](http://www.tahi.org) 上，所有测试均已列出并记录。TAHI 项目已于 2012 年 12 月结束，因为他们认为它已经完成了“通过质量支持 IPv6 开发者，推动高度互操作的 IPv6 世界”的使命。信息和测试工具仍然存在（在撰写本文时）。

TAHI 项目与其他知名项目紧密合作：[WIDE 项目](http://www.wide.ad.jp)、[KAME 项目](http://www.kame.net)，该项目也已经结束（但跳舞的 Kame 仍然存在），以及已结束的 [USAGI 项目](http://www.linux-ipv6.org)。找到一些有趣的链接以及关于 IPv6 早期演进的一些历史。

### 应做和不应做的事项

基于多年的大型企业咨询经验，这里有一些我不断看到的观点和看法，我想总结给你们。有些是成功的，而有些则属于你应该避免的范畴。无论如何，它们都试图为你提供如何开展项目的指导方针。

#### IPv6 就像 IPv4 吗？

通常，尚未开始使用 IPv6 的人有两种观点。第一组认为 IPv6 是显而易见的；毕竟，它与 IPv4 没有太大区别，适应现有的 IPv4 概念并使其运作应该很容易。因此，他们通常认为自己不需要外部帮助，内部人员就能完成，或者他们选择那些拥有良好 IPv4 背景但没有 IPv6 经验的顾问，并假设他们能够完成工作。另一组则认为 IPv6 是一个“杀手”，它过于复杂且难以掌握，认为自己永远无法正确地集成它。因此，他们回避这个项目，并尽可能地避免它，希望问题能自行解决。

这两种观点都比较极端，事实的真相在于它们之间。第一组最好至少让具有良好 IPv6 经验的人来审查他们的 IPv6 策略、地址规划和安全概念。这就像在进行关键治疗前从医生那里获得第二意见。提前修正一些问题远比部署后再去修改或不得不与它共存多年要容易得多。如果审查确认一切正常，那也是一个很好的背景。第二组则只部分正确。虽然 IPv6 是 IPv4 的演进，许多方面是相同的，但在架构上有许多优势和新特性，例如地址架构。因此，建议不要回避，而是在所有团队深入进行网络设计、地址规划和安全概念的设计之前，花时间进行全面的教育。如果你拖延太久，并且在时间压力下完成这一切，你将没有时间去利用 IPv6 集成的机会。

#### 无法避免的 bug 以及为何通用评估不太有用

IPv6 协议栈比大多数 IPv4 协议栈要年轻。虽然我们仍然在修复 IPv4 协议栈中的一些漏洞或寻找安全漏洞，但我们可以预期，在 IPv6 协议栈中这类问题会更为常见，因为我们没有多年操作经验以及多年的测试和修复积累。这导致了两个需要注意的事项。

其中之一是，你需要在规划中为与供应商修复 bug 留出足够的时间。一旦你开始实验室测试和试点项目，你将会发现这些 bug，供应商需要一些时间来提供解决方案。但我在许多 IPv6 战略讨论中听到的另一种说法是，人们会说：“哦，我们不使用这项技术，它不起作用，我们在实验室中测试过了。”

### 注意

不建议将你的设计和目标架构基于当前堆栈中的 bug。设计你的网络和应用程序，以最佳方式适应你的业务和需求，并期待你的供应商修复 bug。

与此密切相关的是，许多组织在没有 IPv6 战略的情况下，进行当前环境的 IPv6 能力评估（例如，“我能否启用 IPv6？”）。这意味着他们会根据功能可用性来设计，而不是先有一个支持业务的清晰战略，再确保有支持该战略的设备和应用程序。如果你希望一个支持你业务的目标架构，你就无法绕过先定义战略、创建详细的 RFC 要求，然后在采购要求中使用这些要求。

#### 供应商战略与 RFC 要求

如前所述，如果你有提供出色 IPv4 服务的供应商（无论是产品、互联网接入、数据中心托管、外包服务，还是咨询服务），不要假设他们在 IPv6 方面也同样是最优秀的。你需要更详细地验证这一点。一些客户选择将 IPv6 集成作为重新评估未来几年供应商战略的一个契机。

以下几点应当考虑：

+   你的供应商面临的挑战和你一样。只是他们应该走在前面，但现实是，他们中的许多人并没有。所以不要假设他们做到了，要亲自核实！

+   一些客户认为他们的供应商知道该做什么，并且可以信任供应商的建议。大多数情况下，这种想法并不成立。你将面对这样的现实：你的采购团队（可能并不太懂技术，且对 IPv6 了解不多）将与供应商的销售人员坐在一起，而这些销售人员甚至不懂怎么拼写 IPv6。所以，除非你提出非常具体且有信息支持的想法和 RFC 要求，否则不能指望供应商能满足你的需求。

+   在规划项目的初期，向你的战略供应商发送意向书，让他们知道你在可预见的未来需要专业的 IPv6 服务。供应商收到的这种意向书越多，他们就越快加速实施。毕竟，他们缺乏实施或功能丰富的主要借口是因为客户没有要求 IPv6。

+   别忘了评估外包合同和 SLA 以考虑 IPv6 的需求和要求。

在评估供应商时，你应该关注以下几点：

+   根据 RFC 列表检查技术特性。获取厂商提供的已实现 RFC 列表，与你的要求进行对比，然后在实验室中测试那些对你计划至关重要的功能是否按预期工作。记住，RFC 要求必须是针对设备的。IPAM 解决方案与防火墙有不同的要求。

+   检查他们员工的 IPv6 知识水平。是否有一个人知道如何操作 IPv6？如果有的话，作为客户，他们的支持可能不足以满足你。确保他们在所有渠道（销售、工程、支持）都有足够的专业人员。

+   确保他们在所有流程中也已经实现了 IPv6（升级流程以确保未来更新的一致性、事件管理等）。

+   不要相信宣传册和事实表。请在实验室中进行测试。

如果没有这些步骤，你可能最终购买到不支持你的 IPv6 策略的产品，或者在部署过程中陷入困境，因为你突然发现所需的关键功能不被支持。正如你可能从其他 IT 项目中知道的那样，这会花费大量的时间和金钱，尤其是当关键的业务服务或其他 IT 项目依赖于此时。

### 注意

为了建立你的 RFC 要求列表，请使用 RFC 6434，“IPv6 节点要求。”除此之外，还有两个有用的模板可供参考：[RIPE554](http://www.ripe.net/ripe/docs/ripe-554) 和 [USGv6 by NIST](http://www-x.antd.nist.gov/usgv6/index.html)。将其作为基础，并根据你的 IPv6 策略进行调整。

还有其他可能有用的文档，如 RFC 7084，“IPv6 客户边缘路由器的基本要求。”2014 年 4 月，关于更新 RIPE554 的讨论开始进行。所以，当你开始使用这些文档时，确保你使用的是最新版本。

### 一般设计指南

每个环境和业务都是不同的，因此 IPv6 策略也会有所不同。无法提供一种适用于每个组织的方案。然而，仍然有一些在大多数环境中都有效的通用策略，以下是一些建议：

+   尽可能使用原生 IPv6，双栈仅在必要时使用（这可能需要很多年）。

+   尽可能部署新的内部服务仅支持 IPv6。

+   仅在必要时使用隧道，并且仅作为临时解决方案。有时建议稍等片刻，从一开始就直接使用原生 IPv6。

+   如果你需要使用隧道，优先选择无状态隧道而非有状态隧道。

+   不要使用 NAT，不要进行转换（除非被迫）。

+   如果必须进行转换，还是优先选择无状态隧道而非有状态隧道。

+   未来的网络是端到端的。

+   扩展的地址架构允许新的安全概念（你可以考虑将服务信息嵌入地址中，以简化访问规则和操作）。

+   根据新的地址架构调整并对齐你的安全概念。

+   考虑新服务（监控、传感器、健康护理、车与车之间通信……根据行业不同而异）。许多新服务对地址的需求更高，并且有更强的移动性要求。

### 注意

越来越多的客户正在考虑尽快将其基础设施迁移到仅支持 IPv6，并将 IPv4 视为一种服务。这种以 IPv6 为中心的策略的主要优势是可以最大限度地降低成本。运营一个仅支持 IPv6 的网络比在双栈网络中并行维护两个协议的成本要低。

### 地址规划

一个好的地址规划是成功部署 IPv6 的基石，并能大大帮助简化网络运营和故障排除。但地址规划对大多数人来说都是一个挑战。我们都经过了很好的地址节约训练，这种训练高效到让它深入我们的身体细胞。在我们为 128 位地址创建有用的 IPv6 地址概念之前，我们必须克服这一反射动作。那么，规则是什么？如何为 IPv6 设计地址概念？这些是本节要讨论的主题，以提供一些指导。

在我们开始之前，我想回顾一下在第二章中提到的关于地址的一些内容，这些内容可能帮助你逐渐克服节约地址的本能反应，解放你的思维，摆脱有限的 IPv4 思维。请在你进行地址概念工作时，将其作为你每天的座右铭：

在第二章中，我展示了通常一个 ISP 会为其客户分配/32 的地址块，并且一个单独的/32 实际上比整个 IPv4 地址空间还要多（因为它有 32 位来定义子网，而每个/64 子网有 64 位用于接口 ID）。到 2013 年为止，全球大约已经分配了 13 万个/32 地址块，这意味着比整个 IPv4 互联网多出 13 万个地址空间。尽管这听起来极其庞大，但这仅占当前可用公共 IPv6 地址池（`2000::/3`）的 0.025%。因此，在设计 IPv6 地址规划时，我们可以稍微宽松一些。

引用 Vint Cerf 的话：

> 广阔的 IPv6 地址空间为重新审视“地址”这一概念提供了重要机会。IETF 只为当前使用分配了 IPv6 地址空间的 1/8，其余的 7/8 地址空间仍待分配。因此，我们可能可以以不同于拓扑端点的方式来解释 IP 地址空间的新片段。这正是目前在互联网发展过程中，集中关注 IPv6 未来的重要性。

好了，现在动动脑细胞，继续阅读吧。顺便提一句，本节大部分内容取自我的配套书籍，*IPv6 规划*（O’Reilly）。我在这里重复这些内容，是因为人们总是会问很多关于 IPv6 地址规划的问题。因此，我决定在本书的这一部分也涵盖地址规划的内容。有关规划的更多细节，请参阅配套书籍。

### 注意

本节假设您已经熟悉第二章中描述的 IPv6 地址架构的技术细节。

实践表明，在许多情况下，客户选择按逻辑分组地址范围，目的是：

+   允许前缀聚合。

+   简化访问列表和防火墙规则的配置、操作和处理。

+   使地址具有可追溯性，以包含地址使用类型或使用地点的信息。

+   使其具有可扩展性；为扩展（更多服务）和增长（更多位置和用户）创造足够的空间。

+   允许高效的网络管理并简化操作。

#### 有什么新变化？

在设计 IPv6 地址规划时，需要考虑三个主要差异：

+   最明显的区别之一（除了地址长度）是我们不再需要可变长度子网掩码（VLSM）。IPv6 地址的前缀或网络部分应该始终是 64 位（/64）。即使是点对点连接呢？是的，即使是点对点连接（有些人选择更改这一规则——您将需要自己决定）。因此，从这个角度看，IPv6 地址更简单。不再需要猜测或错误配置子网掩码。VLSM 为管理 IPv4 地址空间增加了很多复杂性。

+   前面的规则还与以下内容相关：我们不再需要根据子网中的设备数量来调整子网的大小（换句话说，不再需要进行地址节省的操作）。每个子网都可能拥有 2⁶⁴个设备。每个子网中的设备数量将由交换机的容量决定，因此请咨询您的供应商以了解可能的容量。

+   在 IPv6 中，地址被分配给接口。因此，IPv6 地址标识的是接口，而不是主机。而且，在许多情况下，接口会有多个地址，并根据策略或默认地址选择规则选择地址来发起连接。

请抵制为子网使用更大掩码（如/96）的诱惑，以便节省地址空间。虽然标准并不禁止这样做，但遵循/64 边界可以使您的地址规划面向未来。更改此掩码可能会在未来引发许多问题，因为所有开发都是基于/64 掩码的。例如，SLAAC（无状态地址自动配置）在非/64 掩码下无法正常工作。可能还有许多其他流程或服务在非标准子网掩码下会失败。IPv6 为您提供了足够的地址空间！优化它以实现高效管理。

一旦熟悉了 IPv6 地址架构，请列出您如果可以从头开始设计，想要更改的 IPv4 地址规划事项，然后开始设计您的 IPv6 地址方案。

组成部分如下：

+   回顾您当前的 IPv4 地址规划及其运营经验教训。

+   识别当前 IPv4 规划中的约束和不一致之处。

+   根据目标架构识别您的需求。

+   创建不同的地址规划场景以解决这些问题。

+   与所有 IT 团队进行内部评审和讨论。

+   将最佳选项带入实验室，包括您的配置工具，并测试常见的操作场景。

当定义场景时，您需要在以下两个选择之间找到一个良好的平衡：

*专注于路由聚合*

通过将高位分配给拓扑结构（区域、站点）来强调路由聚合，从而减少核心路由表中的路由数量。

*专注于策略聚合*

通过将高位分配给与服务或安全相关的信息（服务、区域）来强调策略聚合，这减少了策略的数量，最小化了用户错误的风险，并简化了管理。

一般来说，将最常见和最重要的信息优先放在高位，并为当前和预见中的选项分配足够的空间。这些选项可以是新站点、新服务、新用户等。

为了构建一个有用的地址规划，请考虑以下几点：

+   基于拓扑结构的前缀聚合。

+   基于您的服务和安全概念的策略聚合。

+   子网一致性（不要包括地址节省机制；关注操作简便性）。

+   使用地址类型（仅全球地址或全球地址加唯一本地地址）。

+   始终为子网和点对点链路分配一个/64 前缀；无需进行主机规划。

+   如果您有多个位置，并且它们有本地互联网接入，建议为每个位置分配至少一个/48 的前缀。

+   如果您是一个全球性组织，考虑为风险缓解目的使用区域地址分配（RIPE、APNIC、ARIN 等）。

+   尽可能遵守四位字节边界（一个四位字节是 4 个二进制位）。

+   使用配置机制和工具（DHCPv6、SLAAC、IPAM/DDI）。

+   不要仅仅为了结构而创建结构；只有真正相关的信息才应该被嵌入。

+   避免直接映射您的 IPv4 地址规划，因为这会延续遗留问题，并限制利用 IPv6 地址空间资源的能力。

+   安全方面。

+   增长（网络、用户、服务）。

+   新服务带来的地址需求增加（监控、传感器、管理等）。

您的地址规划上限是您已获得的范围（根据公司规模是/48 或/32）。您的下限是您必须分配给子网的/64。所以，在这个空间内，您可以定义自己的结构。首先识别您当前的地址库存和对可预见未来的清晰需求，然后使用剩余的位来支持增长。

### 注意

不要忘记定义 IPv6 地址空间分配的清晰流程和规则。

图 9-1 展示了这样一个高级场景的示例。

![高级地址规划示例](img/ipv6_0901.png)图 9-1. 高级地址规划示例

在这个例子中，选择了基于服务和基于拓扑的设计组合。第一个四位（前 4 位）被用来区分 16 种服务类型，然后可以在高级别上为其分配特殊规则。接下来的四位用于区分每种服务类型下的 16 个应用程序。第三个四位用于区分 16 个超级区域，每个超级区域可以有 4,096 个位置（12 位）。每个位置都会分配一个 /56 前缀，并且仍然可以创建 256 个子网。这个地址规划是否合适完全取决于网络、服务目录和组织的安全概念。它只是一个示例，旨在激发你的思考。服务级别方法的主要目标是使安全策略设计和操作更简单。

在各个方面，你需要整合非常庞大的 IPv6 地址空间。这一点再强调也不为过。因此，例如，在子网一致性方面，完全没有必要节省地址空间。

### 注意

为了操作方便和简化管理，保持同一类型位置的子网大小一致，无论那里有多少用户。虽然这是最佳做法，但一开始可能会感到不适应。如果你为未来的扩展留出地址空间，同样也适用这个规则。一个好的规则是：如果你的单元没有痛苦，那么你的规划还不够大。

#### 全局地址与 ULA

如前所述，IPv6 接口通常可以拥有多个地址。你的地址设计的一部分是决定使用哪些地址类型。具体来说，你有两个选择：一般使用全局 IPv6 地址（GUA），或在内部使用唯一本地地址（ULA）。ULA 在 RFC 4193 中有定义，前缀为 `fd00::/8`。它们类似于 IPv4 中的 RFC 1918 私有地址，这意味着它们是可路由的，但应仅限于内部使用，绝不应路由到互联网。例如，它们可以用于内部部署或在尚未分配全局 IPv6 地址空间时构建实验室。

RFC 1918 概念与当前如何使用这些私有 ULA 地址之间有一个很大的区别。使用 ULA 并不意味着你需要 NAT（网络地址转换）来访问互联网。因为 IPv6 接口设计时就支持多种地址类型，所以需要互联网连接的接口将简单地获取一个全球 IPv6 地址，除了 ULA 地址。当连接到内部服务器时，接口将使用其 ULA 地址；当连接到互联网时，则使用全球 IPv6 地址。RFC 6724 定义了默认的地址选择规则来处理这个问题。在较大的网络中，你将拥有关于源地址和目标地址选择规则的政策。所以，采用这种设计时，应该无法从外部访问的内部服务器和数据库只会配置 ULA 地址。如果你想在内部仅使用 ULA 地址，也可以使用 NPTv6（网络前缀转换），该技术在第七章的 NAT 部分中有描述。

### 注意

不需要像 IPv4 中使用私有地址时那样将 ULA 地址与 NAT 结合使用。在 IPv4 中，NAT 需要将多个地址映射到一个或少数几个地址。而在 IPv6 中，需要访问内部服务和互联网的主机只需获取两个地址，一个是 ULA 地址，另一个是 GUA（全球地址）。

在选择是否使用 ULA 或选择全球地址时，这两种方法都有优缺点，并且围绕它们有很多讨论。由于部署较早，目前可供参考的运营经验不多。从技术角度来看，你可以做出任意选择——你需要自己决定。

以下是一些考虑事项：

+   ULA 使你在内部网络中独立于全球前缀，如果需要重新编号网络，这将非常有利。在这种情况下，你的所有内部系统和通信都不会受到影响。如果你拥有 PI（提供商独立）地址空间，这也不是问题。

+   ULA 为你的内部基础设施增加了一层安全性，因为带有关键数据的服务器和数据库无法从外部访问。显然，你仍然需要防火墙来保护系统，但 ULA 提供了额外的保护。有些组织通过保留一部分全球前缀并将其作为仅限内部使用的前缀来实现相同的目标，在边界两侧进行屏蔽。

+   知道你的一些全球地址的攻击者无法推导出内部系统的地址。

+   不应将 ULA（唯一本地地址）与 NAT（网络地址转换）一起使用，因此 NAT 不是一个问题。需要访问互联网的系统可以获得一个全球 IPv6 地址，除此之外还可以使用 ULA 地址。这就是 IPv6 每个接口多个地址架构的优势。

现在，是否使用 ULA（独立的本地地址）取决于你。它们可能在孤立的领域中非常有用，比如制造生产线或数据中心之间的备份流量。许多人决定，在无限的 IPv6 地址空间下，既然他们终于可以为所有系统分配全球地址，他们希望选择这个简单的选项——通过防火墙保护内部系统，并且享有仅需管理一个前缀的优势。对于那些决定同时使用全球地址和 ULA 的人，我希望 IPAM（IP 地址管理）供应商能够足够聪明，开发出能够管理多个前缀的系统，并将子网设计导入 IPAM 解决方案中以便于管理。无论如何，你可能会为这两个前缀选择相同的地址规划。而你的第三个选择是，你可以选择从全球前缀中选一个特定的前缀，仅分配给内部系统，并阻止该前缀与外界的通信。即使使用 ULA，你也需要在边界上专门阻止它们，因为它们不应被路由到互联网。

#### 一般考虑

每当你将某些内容从 IPv4 地址计划转换到 IPv6 地址计划时，请确保不要将 IPv4 中的限制复制到新的概念中。你是在为未来的原生 IPv6 网络创建一个地址概念，而双栈网络只是一个过渡状态——尽管它可能会存在几年。但一旦你开始运行原生的 IPv6-only 网络，你将希望享有几乎无限的地址空间自由，而无需重新编号网络。

长期以来，建议互联网服务提供商（ISP）从其 RIR（区域互联网注册机构）获取一个/32 前缀，而组织和终端站点从其提供商处获取一个/48 前缀，或者将/48 作为 PI 空间。RFC 6177 将终端站点推荐的前缀大小改为不再统一为/48。它指出，“一个适用于所有情况的/48 推荐前缀对于广泛的终端站点范围来说过于简单，不再建议作为单一默认选项。”该 RFC 声明，确定终端站点最佳前缀大小的责任在于运营社区。这引入了一些新的考虑因素。当默认前缀为/48 时，换服务提供商或来自不同提供商的分配总是有相同的前缀边界。而在新的政策下，终端站点可能需要从更大的前缀迁移到更小的前缀，这意味着需要合并子网。如果你有一个/48 并且首先使用低位的位（如果网络大小允许的话），你可以为此做好准备。似乎许多提供商通常为较小站点分配/56 或/52 的前缀。这条规则不适用于大企业；它们将始终获得/48 或更大的前缀。根据 RFC 6177，即使是家庭用户也应获得比/64 子网更大的地址空间。市场上服务的发展表明，未来的家庭网络将有多个子网（智能建筑）。

关于子网大小，规范中并没有禁止你改变/64 边界。但我不推荐这样做，因为这样做会破坏 IPv6 的许多其他功能，应用程序和进程默认假设/64 子网大小。这包括邻居发现（ND）、安全邻居发现（SEND）、隐私扩展、部分移动 IPv6 规范、独立协议的稀疏模式多播（PIM-SM）与嵌入式 RP、通过 IPv6 中介进行的站点多宿（SHIM6）等机制。而且，未来可能还会有更多假设/64 边界的功能。如果你改变了这一点，所有这些功能都会受到影响。

### 注意

创建比/64 更长的前缀的唯一好处是节省地址空间。请记住我们的原则：我们不再需要节省空间。相比管理非标准子网前缀的麻烦，节省空间的好处是微不足道的。

尽管如此，你仍然可以选择使用来自接口 ID 部分的高位来表示特定的系统、服务或网络，以便更容易识别这些 ID。

在分组位时，一个良好且有帮助的实践是始终在 4 位边界上进行分组（*nibble*）。这样，解析地址时会更加容易，因为 4 个位表示一个十六进制数字。

让我们通过一些例子来激活大脑。你可以按位置对子网进行分组，然后再按服务或使用类型进行分组，或者反过来（先按服务类型，再按位置）。

例如，对于前缀`2001:db8:1::/48`，你有 16 位可用于子网划分。你可以按以下方式进行子网划分（L=位置，S=服务，F=空闲）：

```
Location first:       2001:db8:1:LLLLSSSS FFFFFFFF::/64
Service type first:   2001:db8:1:SSSSLLLL FFFFFFFF::/64
```

你选择的选项取决于你的主要目的是否是优化路由，如果是的话，你应该首先选择位置标识符；或者你是否希望优化安全规则和访问控制列表（ACL，通常基于特定服务的过滤器），如果是的话，你应首先选择服务标识符。在某些情况下，组织只为某个位置分配子网，而该位置进一步管理前缀并创建自己的地址规划。在这种情况下，你也应该首先选择位置标识符。

或者，你可能希望将这两种选项结合使用。你可能有一些特定的服务需要在较高层次上进行过滤，因此你会将这些服务的标识符放在子网范围的最高位，接下来是位置位，以优化网络内的路由，最后是识别更多服务的位。

在这个示例中，使用 4 个比特位表示位置和服务类型，你可以创建 16 个位置和服务（2⁴）。你需要根据你想要表示的位置和服务的数量来调整这个方案（并为未来的扩展预留足够的空间）。有时组织会在 VLAN 编号方案中包含位置或服务描述。你也可以在 IPv6 地址规划中反映这一点，将 12 位的 VLAN ID 包含在前缀中。你可以使用十进制表示法（省略 A-F）或将其转换为十六进制表示法。

这些都是关于你创意规划的一般性思路。花时间仔细设计你未来的地址规划，反复讨论所有可能的选项，让许多人，包括外部顾问，审阅你的地址概念提案，以挑战你的计划，并反复检查，直到感觉合适为止。地址设计是下一代网络的基础。如果没有做好，并且在部署项目期间不得不进行更改，这将增加成本并延迟项目进度。从长远来看，如果你使用了一个次优的地址设计，运营成本可能会不必要地高。

#### 接口 ID 的配置

接口 ID 的定义取决于你选择的 IP 地址管理过程。你可以选择*无状态地址自动配置*（SLAAC），其中接口根据 MAC 地址生成接口 ID（RFC 4291 定义的 EUI-64 格式），或者选择*隐私选项*（如 RFC 4941 所定义），其中接口 ID 是随机生成并定期更改的。在较新的操作系统中，微软使用通过随机标识符创建的稳定接口 ID。你可以使用 DHCPv6，并像在 IPv4 中一样分配地址。通过 DHCPv6，该服务可能提供定义接口 ID 的不同选项。为了最佳地保护你的主机，你可能不希望从低的接口 ID 开始并按顺序编号接口。相反，你可能希望使用随机的接口 ID，因为你的接口 ID 越随机和分散，就越难以扫描。

如果你有一个全球 IPv6 前缀并且在内部使用 ULA 前缀，你可能希望为全球前缀使用隐私选项。这样，访问互联网的用户就不容易被追踪，因为他们的接口 ID 会定期更改。对于 ULA 前缀（或在边界处过滤的全球前缀的内部部分），最好分配固定的地址，以便于管理、故障排除、安全性和日志记录。同样，这也取决于供应商是否会提供帮助处理这一问题的 IP 地址管理解决方案。

### 注意

有建议不要使用基于硬件的接口 ID。微软已经使用一个通过随机标识符创建的稳定接口 ID。RFC 7217 定义了一个不基于硬件标识符的稳定接口 ID。有关更多信息，请参阅无状态地址自动配置（SLAAC）章节。

### 你从哪里获得地址空间？

IANA（互联网号码分配局）负责全球 IP 地址系统的协调工作，以及用于路由互联网流量的 ASN（自治系统号）。

RIR（区域互联网注册机构）从 IANA 获取其 IP 地址空间。全球有多个 RIR 来分配它们区域内的地址空间。图 9-2 展示了全球层级结构、RIR 和它们所服务的区域。

![区域互联网注册机构](img/ipv6_0902.png)图 9-2. 区域互联网注册机构

RIR 还为 LIR（本地互联网注册机构）、NIR（国家互联网注册机构）、ISP（互联网服务提供商）提供地址空间，在某些情况下还直接为最终客户提供地址空间。

不同地区的地址政策略有不同。ISP 和客户必须从他们的 RIR 获取所在地区的政策信息。每个 RIR 都有一个网站，提供关于地址空间和政策的所有信息。

### 注意

所有 RIR 的链接可以在[IANA 的网站](http://www.iana.org/numbers)上找到。

客户有几种申请 IPv6 地址空间的选项。

目前有*PA 空间*（*提供商聚合*）和*PI 空间*（*提供商独立*）。PA 空间面向 ISP，提供互联网连接给多个最终客户。为了获得 PA 空间，通常需要成为 RIR 的会员，并支付年费。标准分配大小通常在 /29 到 /32 范围内。然后，提供商将网络分配给他们的客户，通常在 /48 或 /56 范围内。ISP 分配给客户的 PA 空间不能转移到另一个 ISP，因此在更换 ISP 时，需要重新编号（或者使用 NPTv6 前缀转换）。有关分配建议，请参阅 RFC 6177，下面的章节中有描述。

PI 空间面向那些不能或不愿使用其提供商 PA 空间的最终用户。这不需要会员身份，但每个前缀需要支付年费。PI 空间归最终用户所有，并且可以带到下一个 ISP。每一个使用 PI 前缀的互联网地址都会出现在全球路由表中，影响全球所有的路由器。最初，在 IPv6 的早期阶段，计划是不分配 PI 空间，以保持路由表的小巧。但事实证明，这一政策在实践中无法维持。

因此，作为最终客户，你有以下几种选择：

+   来自本地提供商的 PA 空间

+   来自 RIR 的 PA 空间（需要会员资格）

+   来自 RIR 的 PI 空间（年费）

### 注意

你可以从[RIPE](http://www.ripe.net/ripe/docs/ripe-589)获取有关其 IPv6 地址分配和分配政策的官方信息。

再次提醒，本文件编号有效期至 2014 年 3 月。之后你可能需要查看是否有更新版本。

### 你将获得多少空间？

地址分配规则仍在进行中，可能会有所变化。如何使用地址空间的最新更新内容请参考 RFC 6177，《IPv6 地址分配给终端站点》。它包含了如何进一步划分地址空间的建议。它软化了先前版本中的规则（即 RFC 3177），其中家庭网络以及小型和大型企业应获得一个/48 地址块。如前所述，在新版本中，这些规则已经调整，因为前缀大小的具体分配应由操作社区来决定。

RFC 进一步指出：“IPv6 的一个重要目标是显著改变默认和最小的终端站点分配，从‘单个地址’到‘多个网络’，并确保终端站点可以轻松获得地址空间。”

如果你负责分配地址或为你的网络请求地址，那么可以使用 RFC 6177 中关于地址分配的以下规则：

+   地址管理的一个关键原则是，终端站点必须始终能够为其实际和计划的使用获得合理数量的地址空间，并且是按年而非按月的时间范围。实际上，这意味着至少需要一个/64 地址块，在大多数情况下需要更多。必须避免的一个特定情况是，终端站点由于无法获得足够的地址空间而被迫使用 IPv6 到 IPv6 的网络地址转换（NAT）或其他繁琐的地址节省技术。

+   终端站点应能够轻松获得足够的地址空间来编号多个子网（即大于单个/64 的地址块），并支持长期（例如十年或更长时间）合理的增长预测。

+   默认分配大小应考虑到终端站点未来可能需要多个子网的可能性，并避免 IPv4 实践中频繁且持续的申请额外小块地址空间的情况。

+   尽管一个/64 地址块（理论上）可以为几乎无限数量的设备提供地址，但站点应分配足够的地址空间，以便能够适当划分子网，而不是被迫使用地址节省技术，如使用桥接。

+   将一个较长的前缀分配给一个终端站点，相较于该终端站点已分配的现有前缀，可能会增加终端站点的运营成本和复杂性，且对任何人都没有足够的好处。

+   管理和委派 ip6.arpa 下的反向 DNS 树时，应充分考虑在 nibble 边界与非 nibble 边界之间的操作性问题。

+   家庭网络用户应当接收到多个子网。

一个获得/48 前缀的站点有 16 位用于子网划分，这允许创建 65,536 个子网（默认的 IPv6 子网大小为/64）。在特殊情况下，一个非常大的企业可以申请更短的前缀。

### 注意

你的 IPv6 地址规划是你未来网络的基石，应当支持多年的增长，具有可持续性，并且不应当是支离破碎的。所以，不可能绕过这一点，必须坐下来做作业，弄清楚你到底需要多少空间。然后去申请它。

我与来自不同规模的许多客户进行了交谈，从中小型企业到大型企业都有。我不断听到类似这样的说法：“哦，这就是我们拥有的[某种前缀大小]。我们会看看如何适应它。”请不要这么做。现在你可能认为这比你以前使用 IPv4 时拥有的更多，所以你可能能以某种方式适应它。但再说一遍，请不要这么做；你（或者将来需要运营你网络的人）可能会对这个感到非常不满，并且在头痛和运营上的劣势上付出很大的代价。

通过按照本节所描述的方式定义地址规划，你将能够知道自己究竟需要多少地址。有些标准分配可以很容易获得，不需要太多文档。但你不知道这些分配是否足够支持你的目标架构。如果你做好功课，提出一个可持续且良好的规划，发现你需要更多的地址，你可以获得它；这只需要稍微多一点的工作。但这只是开始时的额外工作。如果你回避这点，基于过小的分配来规划地址，你将在未来为此付出代价。因为重新设计和重做会比一开始就做好规划花费更多的精力。

### 使用 IPv6 的多宿主连接

*多宿主连接*是指一个主机或站点可以通过不同的 IP 地址访问。一个多宿主连接的主机有多个全局 IP 地址。这些地址可以来自一个或多个不同的提供商，并且它们可以分配给主机上的一个或多个接口。一个多宿主连接的站点通过来自一个或多个不同提供商的多个全局 IP 地址连接到互联网。

配置多宿主连接的主要原因如下：

*冗余*

当链路失败时，连接可以通过备用链路继续保持。

*负载均衡*

提供更高的吞吐量，因为流量在两个或更多链路之间进行负载均衡。

*成本*

可能希望使用多个提供商——例如，某个提供商可能在某些类型的服务上提供更好的选择。

IPv6 的自动配置功能支持更容易地维护多宿主连接场景，因为设备在识别网络前缀时更为灵活，并且可以根据路由器广告配置多个 IPv6 地址。

在常见的 IPv4 多宿主接入方法中，站点的本地前缀作为独立的路由前缀宣布到域间路由系统中，并传播到路由系统的顶层层次结构。如果站点的地址空间与提供商无关，这种方法工作得很好。但即使这种方法覆盖了多宿主接入的多数需求，它也不具备可扩展性。

因此，多宿主接入是工作组中一个活跃讨论的话题。目标是找到能够提供多宿主接入，而不涉及可扩展性和传输问题的解决方案。一种思路是将节点的标识与位置分开。目前，一个 IP 地址包含了两部分信息，前缀标识位置，IID 标识节点。对此的一个方法是 LISP，详见第七章。在我们等待并希望能找到一种优雅的多宿主接入架构时，目前 IPv6 的多宿主接入与 IPv4 采用相同的方式进行。

## 引入成本

有些人认为引入 IPv6 的成本过高，因此他们甚至没有开始考虑这个问题。另一些人则只关心它会花费多少成本。下一节将介绍需要考虑的方面以及关于 IPv6 商业案例的一些思考。

### 注意事项

Gartner 表示，IPv6 的集成大约占年度 IT 预算的 6%，并按迁移年数分摊。在我们从高层次视角仔细审视这一点的几个案例中，这一估算非常准确。完成迁移后的持续成本估计约为 IT 预算的 1%。

### 硬件和操作系统

在为 IPv6 进行规划并利用更新周期时，硬件升级的成本并不高昂。在许多情况下，IPv6 并不是硬件的一部分，可以作为操作系统的一部分或软件升级来安装。大多数操作系统和应用程序都包含 IPv6，且无需额外费用。如果 IP 功能完全通过硬件实现，或者系统软件无法升级，那么必须更换硬件以支持 IPv6。然而，如果您提前进行规划，这通常可以通过下一次常规生命周期的升级来完成，因此不会产生额外的成本。正如我们的案例研究所示，这一点得到了已经部署 IPv6 的组织的确认。

### 软件

我们在应用开发中的 IPv6 章节中介绍了 IPv6。如今，许多常见的应用程序已经支持 IPv6，或者将在下一个重大版本升级中支持 IPv6。在这种情况下，您可以通过提前规划并利用应用程序的常规生命周期来限制软件的成本。对于专有和自开发的应用程序，情况需要逐一分析。

简单地迁移一个应用程序，确保它能在 IPv6 传输下同样运行良好。创造性的迁移应用程序可能包括使用 IPv6 的高级特性，从而扩展应用程序的灵活性和功能性。这甚至可以被视为引入基于新技术的先进下一代服务的成本，而不仅仅是引入 IPv6 的成本。

### 教育

每一次技术升级都需要教育：对于开发人员、供应商、服务提供商以及组织中的基础设施和系统运营商来说，都是如此。对于家庭用户来说，应该由他们的 ISP 来简化过渡过程。

根据工作职责进行精心规划的教育项目是必不可少的，并能大大促进 IPv6 的顺利引入。对于系统管理员来说，学习所需的时间和精力与维持 IPv4 基础设施的成本是相当的。我们习惯于不断整合新技术以保持网络的先进性。过去，我们必须引入 DHCP、NAT 和 VPN，并且成功掌握了这些技术。一些人曾在双栈网络中工作，掌握了 IPX（Novell）与 TCP/IP 的共存。现在我们将引入 IPv6，而这项挑战并不比以前更大。并且，这值得投入精力、时间和资金，因为从长远来看，维护 IPv6 网络的成本将低于维护 IPv4 网络的成本。那些对 IP 有深入理解并且掌握了上述技术的人，将不会有任何问题掌握 IPv6。

在进行详细设计并进入生产阶段之前，花足够的时间了解 IPv6 是非常值得的。IPv6 中有许多新概念和新可能性，我们需要一些时间来熟悉这些内容，学习如何最好地利用它们，并将我们所学的知识整合到规划中。如果你按照推荐的方式早早开始做实验和实践测试，你将在实际工作中建立自己的理解和经验。

### 注意事项

当我与已经设计和部署了 IPv6 的组织交流时，我问：“最大的风险是什么？”，他们的回答通常是“缺乏教育”。早期且全面的教育让你能够充分利用 IPv6 所提供的机会。

### 规划

集成的最重要方面是规划。这里同样适用这个规则。扩展基础设施以保持其最先进的状态总是需要规划，并应被视为一种投资。我们不再规划 IPv4 的下一次扩展，而是将规划 IPv6 的集成。

规划需要网络架构师和系统工程师，他们必须对 IPv4 和网络概念有良好的理解。他们首先需要的是深入的 IPv6 教育和一个 IPv6 测试环境。规划的重点不应该是如何在 IPv6 上提供相同的服务。它应该包括理解 IPv6 的新特性，并利用这些特性来创建新的架构、安全性、移动性和管理概念。特别是在 IPv6 地址设计和 IPv6 安全设计方面，组织最好花费足够的时间，因为这两者将为你的网络奠定多年的基础。拥有良好的地址和安全设计将节省大量的成本和麻烦。事实上，IPv6 集成的机会就在这里。

### 注意

正如实践所示，要克服 IPv4 思维并学会利用 IPv6 的优势需要一些时间。

提前规划 IPv6 的引入会更加顺利且便宜。逐步集成是最佳方案，因为它可以给你时间在实践中学习并逐步整合。逐步集成之所以可行，是因为有许多可用的过渡机制。

### 其他成本

最高的成本往往出现在你等待的时间过长时。你等待的时间越长，投入到维护和扩展 IPv4 基础设施中的投资就越多。这些钱和精力实际上是你在一个即将淘汰的技术上投入的。你可能需要为 IPv4 构建应急方案（例如，NAT），这些方案日后会使 IPv6 的引入更加复杂。

没有理由拆除一个已经能够满足所有需求的高效网络，但一旦你需要投入资金修复或扩展 IPv4 基础设施时，你应该停下来思考一下 IPv6 是否可以作为替代方案。如前所述，将 IPv6 作为评估标准列入所有 IT 采购清单，特别是对于那些生命周期超过两年的产品，是一个明智的选择。你可能明天不打算启用 IPv6，但或许明年你会考虑启用。如果你的设备和软件已经准备好，那么当时机来临时，你可以无额外成本地启用它。未来在部署新服务时，考虑从一开始就只部署 IPv6。为什么要在 IPv4 上测试并使其工作，如果你迟早还得迁移到 IPv6 呢？显然，这需要一个双栈基础设施。

另一个成本因素是，如果出现基于 IPv6 高级功能的业务关键应用。如果你的基础设施已经准备好支持 IPv6，你可以以适中的成本引入该应用。如果同时你还需要处理过渡到 IPv6 的过程，这可能会带来显著的成本，并使你当前的基础设施面临风险（此外还可能带来一些头痛和失眠的夜晚）。

你已经读完了本书。现在你对 IPv6 规范的要点有所了解，并且掌握了一些过渡机制和规划过程的指南。接下来你需要通过建立实验室和测试，并亲自使用它，来积累经验。祝你玩得开心！  

## 参考文献  

下面是本章提到的最重要的 RFC 和草案的列表。有时我还会为你提供一些额外的相关 RFC，供你个人进一步学习。  

### RFCs  

+   RFC 2185，《IPv6 过渡的路由方面》，1997 年  

+   RFC 2529，《在没有显式隧道的情况下通过 IPv4 域传输 IPv6》，1999 年  

+   RFC 2663，《IP 网络地址转换（NAT）术语和考虑事项》，1999 年  

+   RFC 3022，《传统 IP 网络地址转换器（传统 NAT）》，2001 年  

+   RFC 3053，《IPv6 隧道代理》，2001 年  

+   RFC 3056，《通过 IPv4 云连接 IPv6 域》，2001 年  

+   RFC 3493，《IPv6 的基础套接字接口扩展》，2003 年  

+   RFC 3542，《IPv6 的高级套接字应用程序接口（API）》，2003 年  

+   RFC 3582，《IPv6 站点多宿架构的目标》，2003 年  

+   RFC 3715，《IPsec 网络地址转换（NAT）兼容性要求》，2004 年  

+   RFC 3789，《当前部署的 IETF 标准轨道和实验文档中的 IPv4 地址调查简介》，2004 年  

+   RFC 3790，《当前部署的 IETF 互联网领域标准轨道和实验文档中的 IPv4 地址调查》，2004 年

+   RFC 3791，《当前部署的 IETF 路由领域标准轨道和实验文档中的 IPv4 地址调查》，2004 年  

+   RFC 3792，《当前部署的 IETF 安全领域标准轨道和实验文档中的 IPv4 地址调查》，2004 年  

+   RFC 3793，《当前部署的 IETF 子 IP 领域标准轨道和实验文档中的 IPv4 地址调查》，2004 年  

+   RFC 3794，《当前部署的 IETF 传输领域标准轨道和实验文档中的 IPv4 地址调查》，2004 年  

+   RFC 3795，《当前部署的 IETF 应用领域标准轨道和实验文档中的 IPv4 地址调查》，2004 年  

+   RFC 3796，《当前部署的 IETF 操作与管理领域标准轨道和实验文档中的 IPv4 地址调查》，2004 年  

+   RFC 3901，《DNS IPv6 传输操作指南》，2004 年  

+   RFC 4029，《在 ISP 网络中引入 IPv6 的场景和分析》，2005 年  

+   RFC 4038，《IPv6 过渡的应用方面》，2005 年  

+   RFC 4057，《IPv6 企业网络场景》，2005 年  

+   RFC 4177，《IPv6 多宿的架构方法》，2005 年  

+   RFC 4192，《没有“标志日”的 IPv6 网络重新编号程序》，2005 年  

+   RFC 4213，《IPv6 主机和路由器的基本过渡机制》，2005 年  

+   RFC 4215，《第三代合作伙伴计划（3GPP）网络中的 IPv6 过渡分析》，2005 年  

+   RFC 4218，《与 IPv6 多宿解决方案相关的威胁》，2005 年  

+   RFC 4219，《IPv6 多宿(MULTI6)开发者应考虑的事项》，2005 年  

+   RFC 4241，《IPv6/IPv4 双栈互联网接入服务模型》，2005 年  

+   RFC 4472, “IPv6 DNS 的操作考虑事项与问题”，2006 年

+   RFC 4554, “在企业网络中使用 VLAN 进行 IPv4-IPv6 共存”，2006 年

+   RFC 4659, “IPv6 VPN 的 BGP-MPLS IP 虚拟专用网络（VPN）扩展”，2006 年

+   RFC 4779, “宽带接入网络中的 ISP IPv6 部署情景”，2007 年

+   RFC 4787, “单播 UDP 的网络地址转换（NAT）行为要求”，2007 年

+   RFC 4798, “通过 IPv6 提供商边缘路由器（6PE）使用 IPv4 MPLS 连接 IPv6 岛屿”，2007 年

+   RFC 4852, “IPv6 企业网络分析——IP 层 3 重点”，2007 年

+   RFC 5181, “在 802.16 网络中的 IPv6 部署情景”，2008 年

+   RFC 5375, “IPv6 单播地址分配考虑”，2008 年

+   RFC 5569, “在 IPv4 基础设施上快速部署 IPv6（6rd）”，2010 年

+   RFC 5902, “IAB 关于 IPv6 网络地址转换的思考”，2010 年

+   RFC 6036, “IPv6 部署的新兴服务提供商情景”，2010 年

+   RFC 6052, “IPv4/IPv6 转换器的 IPv6 地址分配”，2010 年

+   RFC 6144, “IPv4/IPv6 转换框架”，2011 年

+   RFC 6146, “有状态 NAT64：从 IPv6 客户端到 IPv4 服务器的网络地址与协议转换”，2011 年

+   RFC 6147, “DNS64：从 IPv6 客户端到 IPv4 服务器的网络地址转换 DNS 扩展”，2011 年

+   RFC 6164, “在路由器间链路上使用 127 位 IPv6 前缀”，2011 年

+   RFC 6177, “IPv6 地址分配到终端站点”，2011 年

+   RFC 6180, “IPv6 部署期间使用 IPv6 过渡机制的指南”，2011 年

+   RFC 6250, “IP 模型的演变”，2011 年

+   RFC 6269, “IP 地址共享的问题”，2011 年

+   RFC 6296, “IPv6 到 IPv6 网络前缀转换”，2011 年

+   RFC 6302, “面向互联网服务器的日志记录建议”，2011 年

+   RFC 6434, “IPv6 节点要求”，2011 年

+   RFC 6459, “IPv6 在第 3 代合作伙伴项目（3GPP）演进分组系统（EPS）中的应用”，2012 年

+   RFC 6540, “所有支持 IP 的节点必须支持 IPv6”，2012 年

+   RFC 6586, “来自 IPv6-only 网络的经验”，2012 年

+   RFC 6724, “互联网协议版本 6（IPv6）的默认地址选择”，2012 年

+   RFC 6866, “企业网络中静态地址 IPv6 主机重新编号的问题声明”，2013 年

+   RFC 6879, “IPv6 企业网络重新编号情景、考虑因素及方法”，2013 年

+   RFC 6883, “面向互联网内容提供商和应用服务提供商的 IPv6 指南”，2013 年

+   RFC 6921, “超光速（FTL）通信的设计考虑”，2013 年 4 月 1 日

+   RFC 7021, “评估载波级 NAT 对网络应用的影响”，2013 年

+   RFC 7050, “IPv6 地址合成中使用的 IPv6 前缀发现”，2013 年

+   RFC 7059, “IPv6-over-IPv4 隧道机制的比较”，2013 年

+   RFC 7066, “第三代合作伙伴项目（3GPP）蜂窝主机的 IPv6 应用”，2013 年

+   RFC 7084, “IPv6 客户边缘路由器的基本要求”，2013 年

+   RFC 7094, “IP 任播的架构考虑”，2014 年

+   RFC 7098, “在服务器集群中使用 IPv6 流标签进行负载均衡”，2013 年

+   RFC 7123, “IPv6 对 IPv4 网络的安全影响”，2014 年

+   RFC 7136，“IPv6 接口标识符的重要性，”2014 年

+   RFC 7157，“没有网络地址转换的 IPv6 多宿主，”2014 年

+   RFC 7168，“茶漏设备的超文本咖啡壶控制协议（HTCPCP-TEA）”，2014 年 4 月 1 日

+   RFC 7217，“一种使用 IPv6 无状态地址自动配置（SLAAC）生成语义上不透明的接口标识符的方法，”2014 年

### 草案

草案可以在 [`www.ietf.org/ID.html`](http://www.ietf.org/ID.html) 找到。要定位草案的最新版本，请参考 [`datatracker.ietf.org/public/pidtracker.cgi`](https://datatracker.ietf.org/public/pidtracker.cgi)。你可以输入草案名称（不需要版本号），系统将显示最新版本。如果草案没有显示，可能已经被删除。如果它已经发布为 RFC，RFC 编号将会显示。[`tools.ietf.org/wg`](http://tools.ietf.org/wg) 也是一个非常有用的网站。有关标准化过程、RFC 和草案的更多信息，请参见 附录 A。

这里列出了我在本章中引用的草案，以及与本章主题相关的有趣草案：

“使用唯一本地地址的建议”

*draft-ietf-v6ops-ula-usage-recommendations-02*

“地址和端口映射与封装（MAP）”

*draft-ietf-softwire-map-10*

“使用转换的地址和端口映射（MAP-T）”

*draft-ietf-softwire-map-t-05*

“DHCPv6 配置软线地址和端口映射客户端的选项”

*draft-ietf-softwire-map-dhcp-07*

“轻量级 4over6：DS-Lite 架构的扩展”

*draft-ietf-softwire-lw4over6-08*

“通过 IPv6 实现 IPv4 残余部署——一种无状态解决方案（4rd）”

*draft-ietf-softwire-4rd-08*

“3GPP 移动设备的 IPv6 配置文件”

*draft-ietf-v6ops-mobile-device-profile-07*

“NAT64 部署选项和经验”

*draft-ietf-v6ops-nat64-experience-10*

“IPv6 数据中心操作指南”

*draft-ietf-v6ops-dc-ipv6-01*

“DHCPv6/SLAAC 交互操作指南”

*draft-liu-v6ops-dhcpv6-slaac-guidance-01*

“IPv6 家庭网络架构原则”

*draft-ietf-homenet-arch-13*
