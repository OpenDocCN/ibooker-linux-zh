# 序言

作为一个程序员（也是一个自称的怪胎），我喜欢跟踪各种内核的最新补充和计算研究。当我第一次在 Linux 中玩弄伯克利包过滤器（BPF）和 Express Data Path（XDP）时，我就爱上了它们。这些工具真是太棒了，我很高兴这本书把 BPF 和 XDP 放在中心舞台上，让更多的人能在他们的项目中开始使用它们。

让我详细介绍一下我的背景，以及为什么我对这些内核接口情有独钟。我曾担任 Docker 核心维护者，与 David 一起工作。如果你不熟悉，Docker 对于容器的过滤和路由逻辑大多是通过调用`iptables`实现的。我对 Docker 的第一个补丁是修复一个问题，即在 CentOS 上的一个版本中，`iptables`的命令行标志不同，因此写入`iptables`失败了。还有很多类似的奇怪问题，任何在软件中调用工具的人可能都能理解。此外，在主机上有成千上万的规则并不是`iptables`的初衷，这会导致性能副作用。

后来我听说了 BPF 和 XDP。这对我来说就像是天籁之音。我的`iptables`伤痕不再因另一个 bug 而流血了！甚至内核社区正在努力[用 BPF 取代`iptables`](https://oreil.ly/cuqTy)！哈利路亚！[Cilium](https://cilium.io)，一个用于容器网络的工具，正在其项目的内部使用 BPF 和 XDP。

但这还不是全部！BPF 能做的远不止满足于`iptables`的使用场景。有了 BPF，你可以跟踪任何系统调用或内核函数，以及任何用户空间程序。[bpftrace](https://github.com/iovisor/bpftrace) 让用户能在 Linux 命令行中拥有类似 DTrace 的能力。你可以追踪所有被打开的文件及调用这些打开操作的进程，统计调用它们的程序的系统调用次数，追踪 OOM killer 等等……世界就在你的掌握中！BPF 和 XDP 还被用于[Cloudflare](https://oreil.ly/OZdmj) 和 [Facebook 的负载均衡器](https://oreil.ly/wrM5-) 中，以防止分布式拒绝服务攻击。我不会剧透 XDP 为何如此擅长丢弃数据包，因为你将在本书的 XDP 和网络章节中了解到！

通过 Kubernetes 社区，我有幸认识了 Lorenzo。他的工具[`kubectl-trace`](https://oreil.ly/Ot7kq) 允许用户在其 Kubernetes 集群中轻松运行自定义跟踪程序。

个人而言，我对 BPF 的最喜爱用途是编写自定义跟踪器，以证明其他人的软件性能不达标或者系统调用次数过多的情况。永远不要低估用硬数据证明别人错误的力量。不要担心，本书将带领你编写你的第一个跟踪程序，让你也能做到这一点。BPF 的美妙之处在于在此之前，其他工具使用丢失队列将样本集发送到用户空间进行聚合，而 BPF 非常适合生产环境，因为它允许在事件源头直接构建直方图和过滤。

我职业生涯的一半时间都在为开发者工具工作。最好的工具允许开发者像你一样在其接口中自主使用，用于作者甚至未曾想象的事物。引用理查德·费曼的话，“我很早就学会了知道某事物的名字与真正了解它之间的区别。”直到现在，你可能只知道 BPF 这个名字，以及它可能对你有用。

我喜欢这本书的原因是它为你提供了创建所有新工具的知识，使用 BPF。阅读并完成练习后，你将有能力像使用超能力一样使用 BPF。你可以将其放在工具箱中，在最需要和最有用时使用。你不仅会学会 BPF；你会理解它。这本书是打开你头脑，看到用 BPF 可以构建的可能性的路径。

这个发展中的生态系统非常令人兴奋！我希望随着更多人开始发挥 BPF 的力量，它会变得更加庞大。我很期待了解本书读者最终构建的东西，无论是追踪疯狂软件错误的脚本，还是自定义防火墙，甚至是[红外解码](https://lwn.net/Articles/759188)。请务必告诉我们你构建了什么！

Jessie Frazelle
