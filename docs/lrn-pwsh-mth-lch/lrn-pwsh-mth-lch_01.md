# 1 在开始之前

PowerShell 刚刚满 15 岁（截至 2021 年 11 月 14 日）。很难相信它已经存在这么长时间了，但仍有大量 IT 人员尚未使用它。我们理解——一天中只有这么多时间，你已经习惯了按照一贯的方式做事。或者也许你的网络安全官不允许你开启 PowerShell，因为它只能被坏人使用。无论如何，我们很高兴你能加入我们的冒险。我们已经在使用 PowerShell 很长时间了。实际上，我们中的两位，James 和 Tyler，实际上是从这本书的早期版本中学习 PowerShell 的。

大约在 2009 年，整个行业发生了巨大的转变，当时人们对 PowerShell 有了新的认识。它既不是一种脚本语言，也不是一种编程语言，因此我们教授 PowerShell 的方式也需要改变。实际上，PowerShell 是一个命令行外壳，在这里你可以运行命令行实用程序。像所有好的外壳一样，它具有脚本功能，但你不必使用它们，而且你当然也不必*从*它们开始。

这本书的前几版是那种文化转变的结果，我们今天仍然保持同样的心态。这是我们迄今为止为那些可能没有脚本背景的人教授 PowerShell 的最佳方法（尽管如果你有脚本背景当然更好）。但在我们开始教学之前，让我们为你设定好舞台。

## 1.1 为什么你不能再忽视 PowerShell

批处理。KiXtart。VBScript。让我们面对现实，PowerShell 并非微软（或任何其他人）在为 Windows 管理员提供自动化能力方面的第一次努力。我们认为了解为什么你应该关注 PowerShell 是很有价值的——当你这样做时，你投入学习 PowerShell 的时间将会得到回报。让我们先回顾一下 PowerShell 出现之前的生活是什么样的，并看看使用这个外壳的一些优点。

### 1.1.1 没有 PowerShell 的生活

Windows 管理员总是乐于在图形用户界面（GUI）中点击来完成任务。毕竟，GUI 大部分是 Windows 的全部意义所在——操作系统毕竟不是叫 *Text*。GUI 很好，因为它们能让你发现你能做什么。你还记得第一次打开 Active Directory 用户和计算机吗？也许你悬停在图标上阅读工具提示，下拉菜单，右键点击东西，所有这些只是为了看看有什么可用。GUI 让学习工具变得更容易。不幸的是，GUI 对投资回报为零。如果你花 5 分钟在 Active Directory 中创建一个新用户（假设你填写了很多字段，这是一个合理的估计），你将永远不会比这更快。一百个用户将需要 500 分钟——除非你学会更快地打字和点击，否则这个过程不会变得更快。

微软试图以某种随意的方式处理这个问题，VBScript 可能是其最成功的尝试。你可能需要一个小时来编写一个 VBScript 脚本，可以从 CSV 文件中导入新用户，但一旦你投入了一个小时，未来创建用户只需几秒钟。VBScript 的问题在于微软并没有全力以赴地支持它。微软必须记得让事情对 VBScript 可访问，而当开发者忘记（或没有时间）时，你就会陷入困境。想通过 VBScript 更改网络适配器的 IP 地址？好吧，你可以。想检查其链路速度？你不能，因为没有人在 VBScript 可以访问的方式中将其连接起来。抱歉。Windows PowerShell 的架构师 Jeffrey Snover 将这称为“最后一公里”。你可以用 VBScript（以及其他类似技术）做很多事情，但它往往会让你在某一点上失望，永远无法到达终点线。

Windows PowerShell 是微软为了做得更好并帮助用户跨越最后一公里而做出的快速尝试。到目前为止，这是一个成功的尝试。微软内部的数十个产品组已经采用了 PowerShell，一个广泛的第三方生态系统依赖于它，一个全球的专家和爱好者社区每天都在推动 PowerShell 的发展。

### 1.1.2 使用 PowerShell 生活的体验

微软对 Windows PowerShell 的目标是构建产品 100% 的管理功能。微软继续构建 GUI 控制台，但这些控制台在幕后执行 PowerShell 命令。这种方法迫使公司确保你可以通过 PowerShell 访问产品上可以做的每一件事。如果你需要自动化重复性任务或创建 GUI 无法很好地实现的过程，你可以进入 PowerShell 并完全控制它。

几年来，包括 Exchange、SharePoint、System Center 产品、Microsoft 365、Azure 以及不要忘记 Windows Admin Center 在内的几个微软产品已经采用了这种方法。非微软产品，包括亚马逊网络服务（AWS）和 VMware，也对 PowerShell 表示了浓厚的兴趣。

Windows Server 2012，PowerShell v3 最初引入的地方，以及更高版本几乎完全由 PowerShell 或 PowerShell 之上的 GUI 来管理。这就是为什么你不能忽视 PowerShell：在过去的几年里，PowerShell 已经成为更多和更多管理的基础。它已经成为包括所需状态配置（DSC）在内的许多高级技术的基石。PowerShell 到处都是！

自问一下这个问题：如果我是负责一支 IT 管理员团队（也许你就是）的人，我会希望谁担任高级、薪酬更高的职位？是每次需要执行任务时需要花费几分钟点击图形用户界面（GUI）的管理员，还是那些在自动化任务后只需几秒钟就能完成任务的管理员？我们从 IT 界的几乎所有其他部分都知道答案。问问思科管理员、AS/400 操作员或 UNIX 管理员。答案是，“我更愿意有一个人能够从命令行更高效地运行事物。”展望未来，Windows 世界将开始分为两组：能够使用 PowerShell 和不能使用 PowerShell 的管理员。我们最喜欢的来自微软 2010 年 TechEd 大会上的 Don Gannon-Jones 的一句话是，“你的选择是 *学习 PowerShell*，还是 *想要搭配薯条吗？*”我们很高兴你决定加入我们，与我们一起学习 PowerShell！

## 1.2 Windows、Linux 和 macOS，哦，我的天

在 2016 年中旬，微软做出了前所未有的决定，开源 PowerShell 版本 6（当时称为 PowerShell Core）。同时，它发布了不带 *Windows* 后缀的 PowerShell 版本，以及针对 macOS 和多个 Linux 版本的构建。太棒了！现在，以对象为中心的 shell 可在许多操作系统上使用，并且可以由全球社区进行发展和改进。因此，对于这本书的这一版，我们尽力展示了 PowerShell 的多平台使用，并包括了 macOS 和 Linux 环境的示例。我们仍然认为 PowerShell 的最大受众将是 Windows 用户，但我们还想要确保你了解它在其他操作系统上的工作方式。

我们尽力使这本书中的所有内容都具备跨平台兼容性。然而，截至本书编写时，Linux 和 macOS 上可用的命令仅有 200 多个，因此我们想要展示的内容并不都能工作。考虑到这一点，我们特别指出第十九章和第二十章，因为它们完全专注于 Windows。

## 1.3 这本书适合你吗？

这本书并不试图满足所有人的需求。微软的 PowerShell 团队大致定义了三个使用 PowerShell 的受众群体：

+   主要运行命令并使用他人编写的工具的管理员（无论操作系统）

+   将命令和工具组合成更复杂的过程，并可能将这些过程打包成经验较少的管理员可以使用的工具的管理员（无论操作系统）

+   管理员（无论操作系统）和创建可重用工具和应用的开发者

这本书主要面向第一个受众群体。我们认为，即使是开发者，了解 PowerShell 如何运行命令也是有价值的。毕竟，如果你要创建自己的工具和命令，你应该了解 PowerShell 使用的模式，因为它们允许你创建在 PowerShell 中运行得尽可能好的工具和命令。

如果你感兴趣于创建脚本来自动化复杂的过程，例如新用户配置，那么你将在本书的结尾看到如何做到这一点。你甚至将看到如何开始创建其他管理员可以使用的命令。但本书不会深入探讨 PowerShell 可能做到的所有事情。我们的目标是让你开始使用 PowerShell，并在生产环境中有效地使用它。

我们还将向你展示几种使用 PowerShell 连接到外部管理技术的方法；远程操作和与通用信息模型（CIM）类以及正则表达式交互是两个很快就能想到的例子。大部分情况下，我们将只介绍这些技术，并专注于 PowerShell 如何连接到它们。这些主题值得有它们自己的书籍（并且已经有了），所以我们只专注于 PowerShell 这一方面。如果你想要自己探索这些技术，我们会提供一些建议。简而言之，这本书并不是你用来学习 PowerShell 的最后一本书，而是设计为非常好的第一步。

## 1.4 如何使用本书

这本书的核心理念是每天阅读一章。你不必在午餐时阅读，但每个章节应该只需要大约 40 分钟来阅读，这样你就有额外的 20 分钟来吃完三明治并练习本章展示的内容。

### 1.4.1 章节内容

在本书的章节中，第二章到第二十六章包含主要内容，为你提供了 25 天的午餐期待。你可以在大约一个月内完成本书的主要内容。尽可能坚持这个计划，不要觉得有必要在给定的一天阅读额外的章节。更重要的是，你花些时间练习每一章展示的内容，因为使用 PowerShell 将有助于巩固你所学的知识。不是每个章节都需要整整一个小时，所以有时你可以在回到工作之前有额外的时间练习（以及享用午餐）。我们发现，当人们每天只专注于一个章节时，他们学得更快，因为这给了你的大脑时间去思考新想法，并给你时间去自己练习。不要急于求成，你可能会发现自己比想象中进步得更快。第二十七章提供了在 PowerShell 之旅中下一步去哪里的一些想法。最后，我们包括附录“PowerShell 速查表”，这是本书正文中提到的所有“陷阱”的汇编；当你想要找到某样东西但记不起在哪里找时，请以此作为参考。

### 1.4.2 实践实验室

大多数主要内容章节都包含一个供你完成的简短实验室。你将获得指示，也许还有一两个提示。这些实验室的答案出现在每个章节的末尾。但请尽量在没有查看答案的情况下完成每个实验室。

### 1.4.3 补充材料

我们制作了一个与本书相关的视频：Tyler 的“如何在 PowerShell 中导航帮助系统”；它可以在 Manning 的免费内容中心找到（[`mng.bz/enYP`](http://mng.bz/enYP)）。

我们还建议访问由 James 运营的 [PowerShell.org](http://PowerShell.org)，以及它的 YouTube 频道 [YouTube.com/powershellorg](http://YouTube.com/powershellorg)，其中包含大量的视频内容。你可以找到 PowerShell + DevOps 全球峰会活动的记录会议、在线社区网络研讨会以及更多内容。全部免费！

### 1.4.4 进一步探索

本书中的几章只是简要介绍了某些酷炫的技术，我们在这些章节的结尾提出了建议，让你自己探索这些技术。我们指出了额外的资源，包括你可以根据需要使用的免费资源，以扩展你的技能集。

### 1.4.5 超越

在学习 PowerShell 的过程中，我们经常想要走一些弯路，探索为什么某些事情会以这种方式工作。我们并没有通过这种方式学到很多额外的实用技能，但我们确实对 PowerShell 是什么以及它是如何工作的有了更深入的理解。我们在书中的一些“超越”部分包含了这些旁路信息。这些内容不会让你花超过几分钟的时间去阅读，但如果你是那种喜欢知道为什么某事会以这种方式工作的人，它们可以提供一些有趣的额外事实。如果你觉得这些部分可能会让你分心，第一次阅读时可以忽略它们。你总是可以在掌握章节的主要材料之后回来探索它们。

## 1.5 设置你的实验室环境

在本书中，你将要在 PowerShell 中进行大量的实践，因此你需要一个实验室环境来进行工作。请勿在公司生产环境中进行实践。

要运行本书中的大多数示例以及完成所有实验室，你只需要安装了 PowerShell 7.1 或更高版本的 Windows 的一份副本。我们建议使用 Windows 10 或更高版本，或者 Windows Server 2016 或更高版本，这两者都自带 PowerShell v5.1。如果你要玩 PowerShell，你将不得不投资于一个包含 PowerShell 的 Windows 版本。对于大多数实验室，我们为你的 Linux 环境提供了额外的说明。

注意：你必须单独下载和安装 PowerShell 7，因为它与预装在 Windows 中的 Windows PowerShell 5.1 并行运行。然而，大多数这些实验室都可以在 Windows PowerShell 中运行。有关如何安装 PowerShell 7 的说明可以在 [`mng.bz/p2R2`](http://mng.bz/p2R2) 找到。

我们还将使用带有最新稳定版本的 PowerShell 扩展的 Visual Studio Code (VS Code)。这个扩展可以从市场安装。如果你使用的是非 Windows 版本的 PowerShell，你将需要考虑的选项会更少。只需从 [`github.com/PowerShell/PowerShell`](http://github.com/PowerShell/PowerShell) 获取适合你版本 macOS 或 Linux（或其他）的正确构建版本，你应该就可以正常使用了。然而，请注意，我们将在示例中使用的大量 *功能* 是 Windows 独有的。例如，在 Linux 上无法获取服务列表，因为 Linux 没有服务（它有守护进程，与它们类似），但我们将尽力使用跨平台示例（例如 `Get-Process`）。

小贴士 你应该能够使用单台运行 PowerShell 的计算机完成这本书中的所有内容，尽管有些内容如果你有两三台计算机，且它们都在同一个域中，会更有趣。

## 1.6 安装 PowerShell

如果你目前还没有安装 PowerShell 7，没关系。我们将在下一章中讲解如何进行安装。如果你想检查 PowerShell 的最新可用版本或下载它，请访问 [`docs.microsoft.com/en-us/powershell`](https://docs.microsoft.com/en-us/powershell)。这个官方的 PowerShell 主页提供了最新发布版本及其安装方法。

小贴士 你应该检查你的 PowerShell 版本：打开 PowerShell 控制台，输入 `$PSVersionTable` 并按 Enter。

在继续之前，请花几分钟时间自定义 PowerShell。如果你使用的是基于文本的控制台宿主，我们强烈建议你将默认控制台字体更改为 Lucida fixed-width 字体。默认字体使得区分 PowerShell 使用的某些特殊标点符号变得困难。按照以下步骤自定义字体：

1.  点击控制框（即控制台窗口左上角的 PowerShell 图标）并从菜单中选择属性。

1.  在出现的对话框中，浏览各个选项卡以更改字体、窗口颜色、窗口大小和位置等。

小贴士 确保窗口大小和屏幕缓冲区具有相同的宽度值。

你的更改将应用于默认控制台，这意味着当你打开新窗口时，这些更改将保留。当然，所有这些仅适用于 Windows：在非 Windows 操作系统上，你通常会安装 PowerShell，打开你的操作系统的命令行（例如，一个 Bash shell），然后运行 `powershell`。你的控制台窗口将决定你的颜色、屏幕布局等，因此请根据你的喜好进行调整。

## 1.7 联系我们

我们热衷于帮助像你这样的人学习 Windows PowerShell，并尽力提供尽可能多的资源。我们也感谢你的反馈，因为这有助于我们提出新的资源想法，我们可以将这些资源添加到网站上，以及改进本书未来版本的方法。在 Twitter 上，你可以联系 Travis (@TravisPlunk)，Tyler (@TylerLeonhardt) 和 James (@PsJamesP)。如果你有 PowerShell 的问题，我们还在 [`forums.powershell.org`](https://forums.powershell.org) 的论坛上活跃。另一个获取更多资源的绝佳地方是 [`powershell.org`](https://powershell.org)，它包括免费的电子书、现场会议、免费网络研讨会以及更多内容。James 帮助管理这个组织，我们强烈推荐它作为你在完成本书后继续 PowerShell 学习的地方。

## 1.8 使用 PowerShell 立即生效

*立即* *生效* 是我们为这本书设定的主要目标。尽可能多，每一章都聚焦于你可以在实际生产环境中立即使用的内容。这意味着我们有时会跳过一些初始细节，但必要时我们承诺会在适当的时候回顾并覆盖这些细节。在许多情况下，我们不得不在用 20 页的理论知识开场，还是直接深入并完成某事而不解释所有细微差别、注意事项和细节之间做出选择。当这些选择出现时，我们几乎总是选择直接深入，目标是让你 *立即生效*。但所有这些重要细节和细微差别都将在本书的后续部分进行解释。

好了，背景介绍就到这里。现在是时候开始立即生效了。你的第一堂午餐课程正在等待。
