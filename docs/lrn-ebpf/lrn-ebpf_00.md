# 前言

在云原生社区及更广泛的领域中，eBPF 已成为近年来最热门的技术话题之一。使用 eBPF 作为平台，网络、安全、可观察性等领域中的一代[强大工具和项目](https://ebpf.io/applications)已经建立（并继续建立），相较于它们的前身，提供了更好的性能和准确性。eBPF 相关的会议如[eBPF 峰会](https://ebpf.io/summit-2022)和[云原生 eBPF 日](https://oreil.ly/q9-p3)吸引了数千名与会者和观众，在撰写本文时，[eBPF Slack](http://ebpf.io/slack)社区已拥有超过 14,000 名成员。

为什么选择 eBPF 作为许多基础设施工具的基础技术？它如何提升性能？eBPF 如何在如此广泛的技术领域中发挥作用，从性能跟踪到网络流量加密？

本书旨在通过让读者了解 eBPF 的工作原理，并介绍如何编写 eBPF 代码，来回答这些问题。

# 读者对象

本书适合开发人员、系统管理员、运维人员和对 eBPF 感兴趣并想了解其工作原理的学生。对于那些希望自己探索编写 eBPF 程序的人来说，本书将为他们提供一个基础。由于 eBPF 为新一代仪器和工具提供了一个良好的平台，未来几年内 eBPF 开发人员可能会有可观的就业机会。

但是，并不一定要计划自己编写 eBPF 代码才能从本书中获益。如果你从事运维、安全或任何涉及软件基础设施的角色，你可能会在现在或未来几年内接触到基于 eBPF 的工具。如果你了解这些工具的内部机制，你将更有能力有效地使用它们。例如，如果你知道事件如何触发 eBPF 程序，那么当 eBPF 基础工具展示性能指标时，你将对它们的真正测量有更清晰的心理模型。如果你是应用程序开发人员，你也可能会接触到一些基于 eBPF 的工具——例如，如果你在性能调优应用程序时，可以使用像[Parca](https://www.parca.dev)这样的工具生成展示哪些函数占用大量时间的火焰图。如果你正在评估安全工具，本书将帮助你了解 eBPF 的优势，并避免以不够有效抵御攻击的天真方式使用它。

即使今天你没有使用 eBPF 工具，我希望这本书能为你提供一些有趣的见解，让你对 Linux 的一些领域有所了解，这些领域可能在之前并没有考虑过。大多数开发者习惯于使用编程语言的高级抽象，这些抽象使他们可以专注于应用程序开发的工作——这本身已经足够难了！他们使用调试器和性能分析器等工具来帮助他们有效地完成工作。了解调试器或性能工具的内部工作原理可能很有趣，但并非必需。然而，对于我们许多人来说，深入探索并了解更多是一种乐趣和满足感。^(1) 同样，大多数人将使用 eBPF 工具，而不必担心它们是如何构建的。[阿瑟·C·克拉克曾写道](https://oreil.ly/gOV1D)：“任何足够先进的技术都是不可区分于魔术的”，但就我个人而言，我喜欢深入挖掘并找出这种魔术如何运作。也许你和我一样，感觉有必要探索 eBPF 编程，以更好地了解这项技术的潜力。如果是这样，我相信你会喜欢这本书。

# 这本书的内容涵盖了什么。

eBPF 仍在快速发展，这使得撰写一本不需要经常更新的全面参考书变得相当困难。然而，有一些基本原理和基础原则不太可能发生显著变化，这正是本书讨论的内容。

第一章通过描述 eBPF 技术的强大之处，并解释在操作系统内核中运行自定义程序的能力如何带来如此多令人兴奋的功能，为书籍开篇。

在第二章中，事情变得更加具体，你将看到一些“Hello World”示例，介绍了 eBPF 程序和映射的概念。

第三章深入探讨了 eBPF 程序的详细内容及其在内核中的运行方式，而第四章则探讨了用户空间应用程序与 eBPF 程序之间的接口。

近年来 eBPF 的一大挑战之一是跨内核版本的兼容性问题。第五章讨论了“编译一次，到处运行”（CO-RE）方法，解决了这个问题。

验证过程可能是区分 eBPF 与内核模块的最重要特征。我将在第六章介绍 eBPF 验证器。

在第七章中，您将了解到多种不同类型的 eBPF 程序及其附着点。其中许多附着点位于网络堆栈内部，第八章更详细地探讨了 eBPF 在网络功能中的应用。第九章则探讨了 eBPF 用于构建安全工具的应用。

如果您希望编写一个与 eBPF 程序交互的用户空间应用程序，有许多可用的库和框架可以帮助您。第十章概述了各种编程语言的选项。

最后，在第十一章中，我将展望未来发展，介绍 eBPF 领域可能会出现的一些新进展。

# 先决知识

本书假设您已经熟悉在 Linux 上使用基本的 shell 命令，并且了解使用编译器将源代码转换成可执行程序的概念。书中提供了一些简单的 Makefile 示例片段，假定您至少对`make`如何使用这些文件有基本的理解。

本书中有很多 Python、C 和 Go 的代码示例。您不需要对这些语言有深入的了解才能从这些示例中获益，但如果您乐意阅读一些代码，将能更好地理解本书内容。我还假设您熟悉*指针*的概念，它们用于标识内存位置。

# 示例代码和练习

本书中有许多代码示例。如果您希望自己尝试一下，您可以在伴随的 GitHub 仓库找到相关代码及其安装和运行说明[*https://github.com/lizrice/learning-ebpf*](https://github.com/lizrice/learning-ebpf)。

我还在大多数章节的末尾包含了练习，以帮助您通过扩展示例或编写自己的程序来探索 eBPF 编程。

由于 eBPF 技术不断发展，您可以使用的功能取决于您所运行的内核版本。许多早期版本中适用的限制在后来的版本中已经解除或放宽。Iovisor 项目详细介绍了[不同 BPF 功能添加在哪些内核版本中](https://oreil.ly/SsnEV)，在本书中，我尽力记录了描述的特定功能是在哪个版本中添加的。示例代码是在内核版本 5.15 上测试的，截至本文撰写时，一些流行的 Linux 发行版尚不支持如此新的内核版本。如果您在本书出版后不久阅读，可能会发现某些功能在贵组织生产环境使用的 Linux 内核上无法运行。

# eBPF 只适用于 Linux 吗？

eBPF 最初是为 Linux 开发的。同样的方法也可以用于其他操作系统——事实上，微软已经在为 Windows 开发[eBPF 实现](https://oreil.ly/k7AvA)。我在第十一章中简要讨论了这一点，但在本书的其余部分中，我将专注于 Linux 的实现，并且所有示例都来自 Linux。

# 本书中使用的约定

本书使用以下印刷约定：

*Italic*

指示新术语，URL，电子邮件地址，文件名和文件扩展名。

`Constant width`

用于程序清单，以及段落内引用程序元素，如变量或函数名，数据库，数据类型，环境变量，语句和关键字。

**`Constant width bold`**

显示用户应直接输入的命令或其他文本。

*`Constant width italic`*

显示应用程序中应用用户提供的值或由上下文确定的值的文本。

###### 提示

此元素表示提示或建议。

###### 注意

此元素表示一般说明。

###### 警告

此元素表示警告或注意事项。

# 使用代码示例

补充材料（代码示例，练习等）可在[*https://github.com/lizrice/learning-ebpf*](https://github.com/lizrice/learning-ebpf)下载。

如果您有技术问题或在使用代码示例时遇到问题，请发送电子邮件至*bookquestions@oreilly.com*。

本书旨在帮助您完成工作。一般来说，如果本书提供了示例代码，您可以在您的程序和文档中使用它。除非您复制了代码的大部分内容，否则无需联系我们请求许可。例如，编写一个使用本书中多个代码片段的程序不需要许可。销售或分发 O’Reilly 书籍中的示例代码则需要许可。通过引用本书回答问题并引用示例代码不需要许可。将本书中大量示例代码整合到您产品的文档中需要许可。

我们感谢您的支持，但通常不需要署名。署名通常包括标题，作者，出版商和 ISBN。例如：“*Learning eBPF* by Liz Rice (O’Reilly). Copyright 2023 Vertical Shift Ltd., 978-1-098-13512-6.”

如果您觉得您使用的代码示例超出了公平使用范围或上述授权，请随时通过*permissions@oreilly.com*与我们联系。

# O’Reilly 在线学习

###### 注意

超过 40 年来，[*O’Reilly Media*](https://oreilly.com)为企业的成功提供技术和商业培训，知识和见解。

我们独特的专家和创新者网络通过书籍、文章和我们的在线学习平台分享他们的知识和专长。O’Reilly 的在线学习平台为您提供按需访问的现场培训课程、深入学习路径、交互式编码环境以及来自 O’Reilly 和其他 200 多家出版商的广泛文本和视频资源。更多信息，请访问[*https://oreilly.com*](https://oreilly.com)。

# 如何联系我们

请将对本书的评论和问题发送至出版商：

+   O’Reilly Media, Inc.

+   1005 Gravenstein Highway North

+   Sebastopol, CA 95472

+   800-998-9938（美国或加拿大）

+   707-829-0515（国际或本地）

+   707-829-0104（传真）

我们有一个专门为本书服务的网页，列出勘误、示例和任何额外信息。您可以访问此页面：[*https://oreil.ly/learning-eBPF*](https://oreil.ly/learning-eBPF)。

电子邮件*bookquestions@oreilly.com*，用于对本书提出评论或技术问题。

关于我们的书籍和课程的新闻和信息，请访问[*https://oreilly.com*](https://oreilly.com)。

在 LinkedIn 上找到我们：[*https://linkedin.com/company/oreilly-media*](https://linkedin.com/company/oreilly-media)。

在 Twitter 上关注我们：[*https://twitter.com/oreillymedia*](https://twitter.com/oreillymedia)。

在 YouTube 上关注我们：[*https://youtube.com/oreillymedia*](https://youtube.com/oreillymedia)。

# 致谢

我要感谢为这本书的撰写做出巨大贡献的众多人士：

+   我的技术审阅人员——Timo Beckers、Jess Males、Quentin Monnet、Kevin Sheldrake 和 Celeste Stinger——提供了详细的、可操作的反馈和改进示例的伟大想法，对此我深表感激。

+   我站在构建、推广和维护 eBPF 的巨匠们的肩膀上，包括 Daniel Borkmann、Thomas Graf、Brendan Gregg、Andrii Nakryiko、Alexei Starovoitov 等无数贡献者，他们不仅贡献了代码，还通过会议演讲和博客文章为社区做出了贡献。

+   感谢我的才华横溢且可爱的 Isovalent 同事们，其中许多人是 eBPF 和内核专家，我从他们身上继续学到很多。

+   同时感谢 O’Reilly 团队，特别是我的编辑 Rita Fernando，在写作过程中给予我无限的支持，并通过帮助计划保持书籍进度；以及 John Devins，他首先鼓励我写这本书。

+   Phil Pearl 不仅在内容上提供了有益的反馈，还确保我吃饱喝足。对于他的支持和鼓励，我将永远感激不尽。

多年来，我也想感谢所有那些花时间对我的工作做出鼓励性评论的美好人士，无论是在活动现场还是在社交媒体上。知道自己所写或录制的内容能帮助他人理解技术概念，或者激发他们想要创作或写作的愿望，这种感觉真是非常鼓舞人心。谢谢！

^(1) 在 2017 年的巴黎 dotGo 大会上，[我做了一个演讲，展示了调试器的工作原理](https://youtu.be/TBrv17QyUE0)。
