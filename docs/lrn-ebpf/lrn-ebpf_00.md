# 前言

在云原生社区及其他领域，eBPF 已成为近年来最热门的技术话题之一。使用 eBPF 作为平台构建了一代新的[强大工具和项目](https://ebpf.io/applications)，涵盖了网络、安全、可观测性等领域，并且相较于它们的前身，提供了更好的性能和准确性。eBPF 相关的会议，如[eBPF 峰会](https://ebpf.io/summit-2022)和[云原生 eBPF 日](https://oreil.ly/q9-p3)，吸引了数千名与会者和观众。截至目前，[eBPF Slack](http://ebpf.io/slack)社区已拥有超过 14,000 名成员。

为什么 eBPF 被选为许多基础设施工具的基础技术？它如何实现了性能的承诺？eBPF 在如此不同的技术领域中如何有用，这些领域涵盖了性能跟踪到网络流量加密？

本书旨在通过让读者了解 eBPF 的工作原理，并介绍编写 eBPF 代码，来回答这些问题。

# 这本书是为谁准备的

本书适用于对 eBPF 感兴趣并想了解更多其工作原理的开发人员、系统管理员、运维人员和学生。对于那些想要探索编写 eBPF 程序的人来说，本书将提供基础。由于 eBPF 为一整代新的仪器和工具提供了一个出色的平台，未来几年可能会有 eBPF 开发人员的就业机会。

但您并不一定需要计划自己编写 eBPF 代码，才能从本书中获益。如果您从事运维、安全或其他涉及软件基础设施的角色，您可能会在现在或未来几年内接触到基于 eBPF 的工具。如果您了解这些工具的内部工作原理，您将更有能力有效地使用它们。例如，如果您知道事件如何触发 eBPF 程序，您将对 eBPF 工具在向您显示性能指标时到底在测量什么有更清晰的认识。如果您是应用程序开发人员，您可能也会接触到一些基于 eBPF 的工具——例如，如果您正在对应用程序进行性能调优，您可能会使用类似[Parca](https://www.parca.dev)的工具生成显示哪些函数占用最多时间的火焰图。如果您正在评估安全工具，本书将帮助您了解 eBPF 的优势，并避免以不够有效的方式使用它来抵御攻击。

即使您今天不使用 eBPF 工具，我希望本书能让您对 Linux 的某些领域有所启发。大多数开发人员认为内核是理所当然的，因为他们使用具有方便的高级抽象的编程语言，这使他们能够专注于应用程序开发的工作——这已经够难了！他们使用调试器和性能分析器等工具来帮助他们有效地完成工作。了解调试器或性能工具的内部工作原理可能很有趣，但并非必要。然而，对于我们许多人来说，深入研究并了解更多是有趣且令人满足的。同样，大多数人将使用 eBPF 工具，而无需担心它们是如何构建的。[阿瑟·C·克拉克写道](https://oreil.ly/gOV1D)，“任何足够先进的技术都是不可区分的魔术”，但就我个人而言，我喜欢深入挖掘并了解魔术是如何实现的。您可能和我一样，感到有必要探索 eBPF 编程，以更好地了解这项技术的可能性。如果是这样，我相信您会喜欢这本书。

# 本书涵盖内容

eBPF 仍在以相当快的速度发展，这使得编写一个不需要不断更新的全面参考资料相当困难。然而，有一些基本原则和基本原则不太可能发生重大变化，这就是本书讨论的内容。

第一章通过描述 eBPF 为何如此强大作为一种技术，并解释在操作系统内核中运行自定义程序的能力如何实现了许多令人兴奋的功能，为您铺设了基础。

在第二章中，事情变得更加具体，您将看到一些“Hello World”示例，介绍了 eBPF 程序和映射的概念。

第三章更详细地探讨了 eBPF 程序及其在内核中的运行方式，第四章探讨了用户空间应用程序与 eBPF 程序之间的接口。

近年来 eBPF 面临的一个重大挑战是跨内核版本的兼容性问题。第五章探讨了解决这一问题的“编译一次，到处运行”(CO-RE)方法。

验证过程可能是区分 eBPF 与内核模块最重要的特征。我将在第六章介绍 eBPF 验证器。

在第七章中，您将介绍许多不同类型的 eBPF 程序及其附着点。其中许多附着点位于网络堆栈内，第八章更详细地探讨了 eBPF 在网络功能中的应用。第九章探讨了 eBPF 如何用于构建安全工具。

如果您想编写一个与 eBPF 程序交互的用户空间应用程序，有许多库和框架可用于帮助。第十章概述了各种编程语言的选项。

最后，在第十一章中，我将凝视我的水晶球，告诉您一些未来可能在 eBPF 世界中展开的发展。

# 先决条件知识

本书假设您对 Linux 上的基本 shell 命令和使用编译器将源代码转换为可执行程序的概念感到舒适。书中还包含了一些简单的 Makefile 示例，假设您至少对`make`如何使用这些文件有一定的了解。

书中有很多 Python、C 和 Go 的代码示例。您不需要深入了解这些语言就可以从这些示例中获益，但如果您乐意阅读一些代码，那么您将从本书中获得最多的收获。我还假设您熟悉*指针*的概念，它们用于标识内存位置。

# 示例代码和练习

本书中有很多代码示例。如果您想自己尝试一下，您会在[*https://github.com/lizrice/learning-ebpf*](https://github.com/lizrice/learning-ebpf)找到相应的 GitHub 存储库以及安装和运行代码的说明。

我还在大多数章节的末尾包含了练习，以帮助您通过扩展示例或编写自己的程序来探索 eBPF 编程。

由于 eBPF 不断发展，您可以使用的功能取决于您运行的内核版本。许多适用于早期版本的限制在后来的版本中已经解除或放宽。Iovisor 项目对[添加了不同 BPF 功能的内核版本](https://oreil.ly/SsnEV)进行了有用的概述，在本书中，我已经尝试记录了我描述的特定功能是在何时添加的。这些示例是使用内核版本 5.15 进行测试的，在撰写本文时，一些流行的 Linux 发行版尚不支持如此近期的内核版本。如果您在本书出版后不久就阅读本书，您可能会发现一些功能在您的组织在生产中使用的 Linux 内核上无法正常工作。

# eBPF 只适用于 Linux 吗？

eBPF 最初是为 Linux 开发的。同样的方法也可以用于其他操作系统——事实上，微软一直在为 Windows 开发[eBPF 实现](https://oreil.ly/k7AvA)。我在第十一章中简要讨论了这一点，但在本书的其余部分中，我专注于 Linux 实现，并且所有示例都来自 Linux。

# 本书中使用的约定

本书中使用了以下排版约定：

*斜体*

表示新术语、URL、电子邮件地址、文件名和文件扩展名。

`等宽字体`

用于程序清单，以及在段落中引用程序元素，如变量或函数名、数据库、数据类型、环境变量、语句和关键字。

**`等宽粗体`**

显示用户应该按照字面意思输入的命令或其他文本。

*`等宽斜体`*

显示应由用户提供的值或由上下文确定的值的文本。

###### 提示

这个元素表示提示或建议。

###### 注意

这个元素表示一般说明。

###### 警告

这个元素表示警告或注意事项。

# 使用代码示例

可下载补充材料（代码示例、练习等）[*https://github.com/lizrice/learning-ebpf*](https://github.com/lizrice/learning-ebpf)。

如果您有技术问题或在使用代码示例时遇到问题，请发送电子邮件至[*bookquestions@oreilly.com*](mailto:bookquestions@oreilly.com)。

本书旨在帮助您完成工作。一般来说，如果本书提供示例代码，您可以在自己的程序和文档中使用它。除非您复制了代码的大部分内容，否则无需征得我们的许可。例如，编写一个程序使用本书中的几个代码块不需要许可。出售或分发 O'Reilly 图书中的示例需要许可。引用本书并引用示例代码来回答问题不需要许可。将本书中大量的示例代码合并到产品文档中需要许可。

我们感谢，但通常不需要署名。署名通常包括标题、作者、出版商和 ISBN。例如：“*Learning eBPF* by Liz Rice (O'Reilly). Copyright 2023 Vertical Shift Ltd., 978-1-098-13512-6。”

如果您认为使用代码示例超出了合理使用范围或上述许可，请随时通过[*permissions@oreilly.com*](mailto:permissions@oreilly.com)与我们联系。

# O'Reilly 在线学习

###### 注意

[*O'Reilly Media*](https://oreilly.com)已经提供技术和商业培训、知识和见解，帮助公司取得成功超过 40 年。

我们独特的专家和创新者网络通过图书、文章和我们的在线学习平台分享他们的知识和专长。O'Reilly 的在线学习平台让您随需应变地访问现场培训课程、深入学习路径、交互式编码环境，以及来自 O'Reilly 和其他 200 多家出版商的大量文本和视频。欲了解更多信息，请访问[*https://oreilly.com*](https://oreilly.com)。

# 如何联系我们

请将有关本书的评论和问题发送至出版商：

+   O'Reilly Media, Inc.

+   1005 Gravenstein Highway North

+   Sebastopol, CA 95472

+   800-998-9938（美国或加拿大）

+   707-829-0515（国际或本地）

+   707-829-0104（传真）

我们为这本书建立了一个网页，列出勘误、示例和任何额外信息。您可以在[*https://oreil.ly/learning-eBPF*](https://oreil.ly/learning-eBPF)上访问此页面。

发送电子邮件至[*bookquestions@oreilly.com*](mailto:bookquestions@oreilly.com)评论或询问有关本书的技术问题。

关于我们的图书和课程的新闻和信息，请访问[*https://oreilly.com*](https://oreilly.com)。

在 LinkedIn 上找到我们：[*https://linkedin.com/company/oreilly-media*](https://linkedin.com/company/oreilly-media)。

在 Twitter 上关注我们：[*https://twitter.com/oreillymedia*](https://twitter.com/oreillymedia)。

在 YouTube 上观看我们：[*https://youtube.com/oreillymedia*](https://youtube.com/oreillymedia)。

# 致谢

我要感谢许多人对这本书的撰写做出了巨大贡献：

+   我的技术审阅者——Timo Beckers、Jess Males、Quentin Monnet、Kevin Sheldrake 和 Celeste Stinger——提供了详细、可操作的反馈和改进示例的好主意，我非常感激。

+   我站在那些建立、推广和继续维护 eBPF 的巨人们的肩膀上，包括 Daniel Borkmann、Thomas Graf、Brendan Gregg、Andrii Nakryiko、Alexei Starovoitov，以及无数其他为社区贡献了不仅是代码，还有会议演讲和博客文章的人。

+   感谢我在 Isovalent 的才华横溢和可爱的同事，其中许多人是 eBPF 和内核专家，我从他们身上不断学到很多。

+   感谢 O'Reilly 的团队，特别是我的编辑 Rita Fernando，在写作过程中给予我无尽的支持，以及帮助保持图书进度的规划；还有 John Devins，鼓励我首先写这本书。

+   Phil Pearl 不仅对内容给予了有益的反馈，还确保我吃饱了，休息了。我将永远感激他的支持和鼓励。

我还要感谢多年来所有美妙的人们，他们抽出时间对我的工作进行鼓励性评论，无论是在活动现场还是在社交媒体上。知道我所写或录制的东西帮助了别人理解技术概念，或者激发了他们自己构建或写作的愿望，这让我感到非常鼓舞。谢谢！

¹ 在 2017 年的 dotGo 巴黎大会上，[我做了一个演讲，展示了调试器的工作原理](https://youtu.be/TBrv17QyUE0)。
